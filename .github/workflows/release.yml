name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write  # 创建 Release 并上传文件

jobs:
  # ────────────────────────────────────────────
  # 1. Android APK
  # ────────────────────────────────────────────
  apk:
    name: Build APK
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: zulu
          java-version: '17'

      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('frontend/android/**/*.gradle*') }}

      - name: Install deps & codegen
        working-directory: frontend
        run: |
          flutter pub get
          dart run build_runner build --delete-conflicting-outputs

      - name: Build Release APK
        working-directory: frontend
        env:
          GRADLE_OPTS: "-Dorg.gradle.daemon=false"
        run: flutter build apk --release

      - name: Upload APK to Release
        uses: softprops/action-gh-release@v2
        with:
          files: frontend/build/app/outputs/flutter-apk/app-release.apk

  # ────────────────────────────────────────────
  # 2. 后端完整包（含 Flutter Web 静态文件）
  #    解压后 cd backend && docker compose up -d 即可
  # ────────────────────────────────────────────
  bundle:
    name: Build Bundle (backend + web)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 构建 Flutter Web
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install deps & codegen
        working-directory: frontend
        run: |
          flutter pub get
          dart run build_runner build --delete-conflicting-outputs

      - name: Build Flutter Web
        working-directory: frontend
        run: flutter build web --release

      # 将 Web 产物复制到 backend/static/（FastAPI 会自动挂载）
      - name: Copy web build → backend/static
        run: |
          mkdir -p backend/static
          cp -r frontend/build/web/. backend/static/

      # 将整个 backend 目录打包（忽略运行时产物）
      - name: Package backend zip
        run: |
          zip -r vaultstream-${{ github.ref_name }}.zip backend/ \
            --exclude "backend/.env" \
            --exclude "backend/data/*" \
            --exclude "backend/logs/*" \
            --exclude "backend/__pycache__/*" \
            --exclude "backend/.venv/*" \
            --exclude "backend/venv/*" \
            --exclude "backend/.pytest_cache/*" \
            --exclude "backend/tests/outputs/*"

      - name: Upload bundle to Release
        uses: softprops/action-gh-release@v2
        with:
          files: vaultstream-${{ github.ref_name }}.zip
          body: |
            ## 安装方式

            1. 下载 `vaultstream-${{ github.ref_name }}.zip` 并解压
            2. 进入 `backend/` 目录，复制并编辑配置：
               ```bash
               cp .env.example .env
               # 修改 BASE_URL 和 CORS_ALLOWED_ORIGINS 为你的域名
               ```
            3. 启动：
               ```bash
               docker compose up -d
               ```
            4. 查看日志获取 API 密钥：
               ```bash
               docker logs vaultstream
               ```

            **前端已内嵌**，无需单独部署。APK 另见下方附件。
