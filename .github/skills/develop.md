# VaultStream 开发执行规范（skill.md）

> 目标：确保每次代码改动都可追踪、可验证、可交付。

## 0. 版本演进策略（当前项目约束）

- 当前项目未公开发布：默认不保留旧逻辑兼容层。
- 进行功能替换时，直接删除旧逻辑并落地新逻辑，不做双轨并存。
- 若涉及数据结构变更，必须同步新增数据库迁移文件（`backend/migrations/`）。
- 文档只描述当前实现，不写“弃用说明/兼容说明/历史对比说明”。

## 1. Python 环境与命令基线

- 后端相关命令统一从仓库根目录执行，并显式使用该解释器。

## 2. 标准修改流程（每次任务都遵循）

1. 明确需求边界：先定义本次只改哪些功能，不做无关改动。
2. 定位影响范围：后端、前端、接口、数据结构、数据库迁移、文档是否联动。
3. 先小步修改再验证：单文件/单模块完成后立即做局部检查。
4. 全链路验证：至少做与本次功能直接相关的分析或测试。
5. 补齐文档与注释：代码和文档同步更新，避免“代码新、文档旧”。
6. 按功能拆分提交：每个 commit 只包含一个清晰功能点。

## 3. 代码注释要求（必须）

- 新增或改动的关键逻辑必须有注释，说明“为什么这样做”。
- 注释重点：业务规则、边界条件、状态流转、兼容处理、异常策略。
- 禁止无信息注释（例如“设置变量”“调用函数”）。
- 注释应与当前实现一致，修改逻辑时同步更新或删除过期注释。

## 4. 文档同步要求（必须）

满足任一条件必须更新文档：

- API 路径、请求参数、响应结构有变化。
- 业务流程或状态机有变化。
- 运行方式、配置项、依赖环境有变化。

文档写作约束：

- 仅描述当前有效实现与当前接口。
- 不写“废弃/弃用/兼容旧逻辑/历史方案对比”描述。

推荐同步目标：

- 接口变更：`docs/API.md`
- 架构/流程变更：`docs/ARCHITECTURE.md`、`docs/WORKFLOWS.md`、`docs/PUSH_LOGIC.md`
- 分发相关专项：`docs/refactor-distribution-architecture.md`、`docs/DISTRIBUTION_WORKFLOW_OPTIMIZATION.md`

## 5. 测试覆盖要求（必须）

- 每次改动至少包含“与改动直接相关”的测试验证。
- 后端改动：优先补充/运行对应 pytest。
- 前端改动：至少运行 `flutter analyze`，有逻辑改动时补充 widget/unit test。
- 涉及数据库结构调整：补充迁移验证（迁移可执行、核心读写路径正常）。
- 回归标准：新增功能可测、旧功能不被破坏、关键路径可重复验证。

## 6. 提交规范（按功能分 commit）

### 6.1 拆分原则

- 一个 commit 只做一件事：
  - 例如“新增 migration 并切换到新字段模型”
  - 例如“移除旧接口并切换新接口调用”
  - 例如“补齐该功能的测试”
  - 例如“同步文档描述到当前实现”
- 不把无关格式化、重命名、重构混入业务提交。

### 6.2 推荐提交顺序

1. `refactor/feat/fix`：功能代码改动
2. `test`：测试补充与修复
3. `docs`：文档同步

### 6.3 提交信息建议

- 使用清晰前缀：`feat:` `fix:` `refactor:` `test:` `docs:`
- 标题写明模块 + 动作 + 结果。
- 示例：
  - `refactor: 移除旧分发接口并统一队列项 push-now`
  - `test: 修复 review_page 测试与新模型字段对齐`
  - `docs: 更新分发架构文档为当前实现`

## 7. 提交前检查清单（Checklist）

- [ ] 改动代码有必要注释，且注释未过期
- [ ] 相关文档已同步更新
- [ ] 已执行对应测试/分析并通过
- [ ] commit 已按功能拆分，信息清晰
- [ ] 无无关文件混入提交

## 8. 本项目执行底线

- 先保证正确性，再考虑优化。
- 优先清理根因，不做表面补丁。
- 不修改与需求无关的模块。
- 代码、测试、文档三者必须一致。
