# VaultStream Nginx 配置参考
# 使用场景：下载 Release zip 解压后，Nginx 直接托管前端静态文件，FastAPI 仅处理 API
#
# 部署路径（根据实际解压位置修改，下方 /opt/vaultstream 仅为示例）：
#   后端根目录：  /opt/vaultstream/backend/
#   前端静态文件：/opt/vaultstream/backend/static/     ← zip 解压后已存在
#   媒体文件：    /opt/vaultstream/backend/data/media/  ← 运行时生成
#
# 使用方式：
#   cp nginx.conf.example /etc/nginx/sites-available/vaultstream
#   ln -s /etc/nginx/sites-available/vaultstream /etc/nginx/sites-enabled/
#   # 替换 your-domain.com 和文件路径
#   nginx -t && systemctl reload nginx

server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;

    # SSL 证书（推荐 Let's Encrypt）
    ssl_certificate     /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_ciphers         HIGH:!aNULL:!MD5;

    # ── 前端静态文件（Nginx 直接托管，不经过 FastAPI）──────────────────
    root /opt/vaultstream/backend/static;
    index index.html;

    # Flutter Web SPA 路由回退
    location / {
        try_files $uri $uri/ /index.html;
    }

    # ── 后端 API ──────────────────────────────────────────────────────
    location /api/ {
        proxy_pass         http://127.0.0.1:8000;
        proxy_set_header   Host $host;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_read_timeout 300s;
        proxy_buffering    off;   # SSE 实时推送必须关闭
    }

    # ── SSE（实时推送事件）─────────────────────────────────────────────
    location /api/v1/events {
        proxy_pass             http://127.0.0.1:8000;
        proxy_set_header       Host $host;
        proxy_http_version     1.1;
        proxy_set_header       Connection '';
        proxy_cache            off;
        proxy_buffering        off;
        chunked_transfer_encoding on;
        proxy_read_timeout     86400s;
    }

    # ── 媒体文件（Nginx 直接托管，带缓存头）──────────────────────────
    location /media/ {
        alias /opt/vaultstream/backend/data/media/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # ── 上传大小限制 ──────────────────────────────────────────────────
    client_max_body_size 50M;
}
