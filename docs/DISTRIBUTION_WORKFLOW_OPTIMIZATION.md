# åˆ†å‘ç³»ç»Ÿæ¶æ„ä¼˜åŒ–ä¸å®Œæ•´æµç¨‹è®¾è®¡

> æ–‡æ¡£åˆ›å»ºæ—¶é—´: 2026-02-13
> æœ€åæ›´æ–°: 2026-02-13
> 
> æœ¬æ–‡æ¡£é˜è¿° VaultStream åˆ†å‘å¼•æ“çš„å››å±‚æ¶æ„è®¾è®¡ã€å®Œæ•´ä½¿ç”¨æµç¨‹ä»¥åŠä¼˜åŒ–æ–¹æ¡ˆã€‚
> 
> **å®æ–½çŠ¶æ€**: ç¬¬ä¸€é˜¶æ®µï¼ˆP0ï¼‰+ ç¬¬äºŒé˜¶æ®µï¼ˆP1 ä¸šåŠ¡æµç¨‹ï¼‰å·²å®Œæˆ âœ… â€” å½“å‰è¿›å…¥ç¬¬ä¸‰é˜¶æ®µï¼ˆP1 ä½“éªŒä¼˜åŒ–ï¼ŒWebSocket å®æ—¶é€šçŸ¥ï¼‰

---

## ç›®å½•

1. [Bot é…ç½®åŠŸèƒ½éœ€æ±‚](#ä¸€bot-é…ç½®åŠŸèƒ½éœ€æ±‚)
2. [ä¼˜åŒ–åçš„å››å±‚æ¶æ„è®¾è®¡](#äºŒä¼˜åŒ–åçš„å››å±‚æ¶æ„è®¾è®¡)
3. [å®Œæ•´ä½¿ç”¨æµç¨‹](#ä¸‰å®Œæ•´ä½¿ç”¨æµç¨‹)
4. [å…³é”®ä¼˜åŒ–ç‚¹](#å››å…³é”®ä¼˜åŒ–ç‚¹)
5. [å®æ–½é¡ºåºå»ºè®®](#äº”å®æ–½é¡ºåºå»ºè®®)
6. [é™„å½•ï¼šå…³é”®ä»£ç ç‰‡æ®µ](#é™„å½•å…³é”®ä»£ç ç‰‡æ®µ)

---

## ä¸€ã€Bot é…ç½®åŠŸèƒ½éœ€æ±‚

### å½“å‰çŠ¶æ€

- **Telegram Bot**: Token é€šè¿‡ç¯å¢ƒå˜é‡ `TELEGRAM_BOT_TOKEN` é…ç½®ï¼Œç¡¬ç¼–ç åœ¨ `app/push/telegram.py`
- **Napcat (QQ)**: é…ç½®åœ¨ `app/push/napcat.py`ï¼Œéœ€è¦ `NAPCAT_HTTP_URL` å’Œ `NAPCAT_WS_URL`
- **BotRuntime è¡¨**: åªå­˜å‚¨è¿è¡Œæ—¶çŠ¶æ€ï¼ˆå¿ƒè·³ã€ç‰ˆæœ¬ï¼‰ï¼Œä¸å­˜å‚¨é…ç½®ä¿¡æ¯

### æ”¹è¿›æ–¹å‘

#### 1. æ–°å»º `BotConfig` æ¨¡å‹

å­˜å‚¨å¤š Bot è´¦å·çš„é…ç½®ä¿¡æ¯ï¼š

```python
class BotConfig(Base):
    """Bot é…ç½®è¡¨ï¼ˆæ”¯æŒå¤š Bot ç®¡ç†ï¼‰"""
    __tablename__ = "bot_configs"
    
    id = Column(Integer, primary_key=True)
    platform = Column(String(20), nullable=False)  # telegram | qq
    name = Column(String(100), nullable=False)  # ç”¨æˆ·è‡ªå®šä¹‰åç§°
    
    # Telegram ä¸“ç”¨
    bot_token = Column(String(200))
    
    # QQ/Napcat ä¸“ç”¨
    napcat_http_url = Column(String(200))
    napcat_ws_url = Column(String(200))
    
    # çŠ¶æ€
    enabled = Column(Boolean, default=True)
    is_primary = Column(Boolean, default=False)  # æ˜¯å¦ä¸ºä¸» Bot
    
    # å…ƒæ•°æ®
    bot_id = Column(String(50))  # TG: bot_id, QQ: qq_number
    bot_username = Column(String(100))
    
    # å…³ç³»
    chats = relationship("BotChat", back_populates="bot_config")
    
    created_at = Column(DateTime, default=utcnow)
    updated_at = Column(DateTime, default=utcnow, onupdate=utcnow)
```

#### 2. åç«¯ API ç«¯ç‚¹

- `POST /api/v1/bot-config` - æ·»åŠ  Bot é…ç½®
- `GET /api/v1/bot-config` - åˆ—å‡ºæ‰€æœ‰ Bot
- `PATCH /api/v1/bot-config/{id}` - æ›´æ–° Bot é…ç½®
- `DELETE /api/v1/bot-config/{id}` - åˆ é™¤ Bot
- `GET /api/v1/bot-config/{id}/qr-code` - è·å– Napcat ç™»å½•äºŒç»´ç ï¼ˆWebSocket æµå¼ä¼ è¾“ï¼‰
- `POST /api/v1/bot-config/{id}/activate` - æ¿€æ´»/åˆ‡æ¢ä¸» Bot
- `POST /api/v1/bot-config/{id}/sync-chats` - åŒæ­¥è¯¥ Bot çš„ç¾¤ç»„åˆ—è¡¨

#### 3. å‰ç«¯åŠŸèƒ½

- **Bot ç®¡ç†é¡µé¢** (`BotManagementPage`)
  - åˆ—å‡ºæ‰€æœ‰å·²é…ç½®çš„ Bot
  - æ˜¾ç¤ºåœ¨çº¿çŠ¶æ€ã€å…³è”ç¾¤ç»„æ•°
  - æ”¯æŒå¿«æ·åˆ‡æ¢ä¸» Bot
- **æ·»åŠ  Bot å‘å¯¼** (`AddBotWizard`)
  - æ­¥éª¤ 1: é€‰æ‹©å¹³å°ï¼ˆTelegram/QQï¼‰
  - æ­¥éª¤ 2: è¾“å…¥å‡­è¯
    - Telegram: Bot Token + å®æ—¶éªŒè¯
    - QQ: Napcat URL + æ˜¾ç¤ºç™»å½•äºŒç»´ç 
  - æ­¥éª¤ 3: è‡ªåŠ¨åŒæ­¥ç¾¤ç»„åˆ—è¡¨

---

## äºŒã€ä¼˜åŒ–åçš„å››å±‚æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬ 1 å±‚ï¼šBot æœ¬ä½“ (BotConfig)                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚  èŒè´£ï¼šç®¡ç† Bot è´¦å·çš„èº«ä»½å‡­è¯å’Œè¿æ¥ä¿¡æ¯                          â”‚
â”‚  å­—æ®µï¼š                                                        â”‚
â”‚    - platform: telegram | qq                                 â”‚
â”‚    - bot_token (TG) | napcat_api_url (QQ)                   â”‚
â”‚    - enabled, is_primary                                     â”‚
â”‚  å…³ç³»ï¼šä¸€å¯¹å¤š â†’ BotChat                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“ has_many
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬ 2 å±‚ï¼šBot åŠ å…¥çš„ä¼šè¯ (BotChat)                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚  èŒè´£ï¼šå­˜å‚¨ Bot å·²åŠ å…¥çš„ç¾¤ç»„/é¢‘é“/ç§èŠçš„èº«ä»½ä¿¡æ¯                   â”‚
â”‚  å­—æ®µï¼š                                                        â”‚
â”‚    - bot_config_id (å¤–é”® â†’ BotConfig)                        â”‚
â”‚    - chat_id, chat_type, title, username                    â”‚
â”‚    - is_accessible, last_sync_at                            â”‚
â”‚  å…³ç³»ï¼šå¤šå¯¹å¤š â†” DistributionRule (é€šè¿‡ä¸­é—´è¡¨)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†‘                    â†‘
                    belongs_to          many_to_many (via)
                           â”‚                    â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬ 3 å±‚ï¼šåˆ†å‘è§„åˆ™         â”‚       â”‚  ç¬¬ 4 å±‚ï¼šå…³è”é…ç½® (ä¸­é—´è¡¨)        â”‚
â”‚  (DistributionRule)       â”‚â—„â”€â”€â”€â”€â”€â”€â”‚  (BotChatRuleConfig)             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚       â”‚  åŸå DistributionTarget          â”‚
â”‚  èŒè´£ï¼šå®šä¹‰å†…å®¹è¿‡æ»¤æ¡ä»¶     â”‚       â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚  ä¸æ¨é€æ ¼å¼               â”‚       â”‚  èŒè´£ï¼šè¿æ¥è§„åˆ™ä¸ç¾¤ç»„              â”‚
â”‚  å­—æ®µï¼š                   â”‚       â”‚  å­—æ®µï¼š                           â”‚
â”‚    - match_conditions    â”‚       â”‚    - rule_id (FK)                â”‚
â”‚    - render_config       â”‚       â”‚    - bot_chat_id (FK)            â”‚
â”‚    - priority, enabled   â”‚       â”‚    - enabled                     â”‚
â”‚    - nsfw_policy         â”‚       â”‚    - merge_forward (QQä¸“ç”¨)      â”‚
â”‚    - approval_required   â”‚       â”‚    - use_author_name             â”‚
â”‚                          â”‚       â”‚    - summary                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒå…³ç³»è¯´æ˜

1. **1:N** - `BotConfig` â†’ `BotChat`
   - ä¸€ä¸ª Bot è´¦å·å¯ä»¥åŠ å…¥å¤šä¸ªç¾¤ç»„/é¢‘é“
   - ç¤ºä¾‹ï¼š@MyNewsBot åŠ å…¥äº† 10 ä¸ª Telegram é¢‘é“

2. **M:N** - `BotChat` â†” `DistributionRule`
   - é€šè¿‡ `BotChatRuleConfig` (åŸ `DistributionTarget`) å…³è”
   - ç¤ºä¾‹ï¼š
     - "ç§‘æŠ€æ–°é—»"è§„åˆ™ â†’ æ¨é€åˆ° é¢‘é“Aã€é¢‘é“Bã€ç¾¤ç»„C
     - é¢‘é“A â† æ¥æ”¶ "ç§‘æŠ€æ–°é—»"ã€"AIåŠ¨æ€"ã€"å¼€æºé¡¹ç›®" ä¸‰ä¸ªè§„åˆ™çš„å†…å®¹

3. **é…ç½®ç®¡ç†ç­–ç•¥**
   - Rule å®šä¹‰æ¸²æŸ“æ ¼å¼ï¼ˆæ¯ä¸ªè§„åˆ™å®Œæ•´é…ç½®ï¼‰
   - **ä¸æ”¯æŒé’ˆå¯¹ç‰¹å®šç¾¤ç»„è¦†ç›–**ï¼ˆä¿æŒæ¶æ„æ¸…æ™°ï¼‰
   - å¦‚éœ€ä¸åŒæ ¼å¼ï¼Œä½¿ç”¨ **Fork è§„åˆ™** åŠŸèƒ½ï¼š
     ```json
     // åŸè§„åˆ™ï¼šç§‘æŠ€æ–°é—»ï¼ˆå®Œæ•´ç‰ˆï¼‰
     {
       "name": "ç§‘æŠ€æ–°é—»",
       "render_config": {
         "layout": "card",
         "show_author": true,
         "show_tags": true
       }
     }
     
     // Fork æ–°è§„åˆ™ï¼šç§‘æŠ€æ–°é—» - ç®€æ´ç‰ˆ
     POST /api/v1/distribution-rules/{id}/fork
     {
       "new_name": "ç§‘æŠ€æ–°é—» - ç®€æ´ç‰ˆ",
       "render_config": {
         "layout": "minimal",
         "show_tags": false
       },
       "inherit_targets": false  // ä¸ç»§æ‰¿åŸè§„åˆ™çš„æ¨é€ç›®æ ‡
     }
     ```

---

## ä¸‰ã€å®Œæ•´ä½¿ç”¨æµç¨‹

### é˜¶æ®µ 1: åˆå§‹åŒ– Botï¼ˆä¸€æ¬¡æ€§é…ç½®ï¼‰

```
â”Œâ”€ ç”¨æˆ·æ“ä½œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€ ç³»ç»Ÿå“åº” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                â”‚  â”‚                            â”‚
â”‚ 1. æ‰“å¼€"è®¾ç½®" â†’ "Bot ç®¡ç†"      â”‚  â”‚                            â”‚
â”‚                                â”‚  â”‚                            â”‚
â”‚ 2. ç‚¹å‡»"æ·»åŠ  Bot"               â”‚  â”‚ â†’ æ˜¾ç¤ºå‘å¯¼                  â”‚
â”‚    - é€‰æ‹©å¹³å° (Telegram/QQ)    â”‚  â”‚                            â”‚
â”‚    - [TG] è¾“å…¥ Bot Token       â”‚  â”‚ â†’ éªŒè¯ Token æœ‰æ•ˆæ€§         â”‚
â”‚    - [QQ] è¾“å…¥ Napcat API åœ°å€ â”‚  â”‚ â†’ è½®è¯¢è·å–ç™»å½•äºŒç»´ç          â”‚
â”‚                                â”‚  â”‚   æ˜¾ç¤ºåœ¨å¼¹çª—ä¸­æ‰«ç            â”‚
â”‚                                â”‚  â”‚                            â”‚
â”‚ 3. ç¡®è®¤æ·»åŠ                      â”‚  â”‚ â†’ POST /bot-config         â”‚
â”‚                                â”‚  â”‚ â†’ è‡ªåŠ¨è§¦å‘"åŒæ­¥ç¾¤ç»„"         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â†“
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚ ç³»ç»Ÿè‡ªåŠ¨æ“ä½œï¼š     â”‚
                                    â”‚ - è°ƒç”¨ TG getMe  â”‚
                                    â”‚ - è°ƒç”¨ getChats  â”‚
                                    â”‚ - åˆ›å»º BotChat   â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ’¡ ä¼˜åŒ–ç‚¹ 1: è‡ªåŠ¨åŒæ­¥ + å®æ—¶è¿›åº¦**
- **å½“å‰ç—›ç‚¹**: éœ€è¦æ‰‹åŠ¨ç‚¹å‡»"åŒæ­¥ç¾¤ç»„"æŒ‰é’®
- **ä¼˜åŒ–æ–¹æ¡ˆ**: æ·»åŠ  Bot åè‡ªåŠ¨åå°åŒæ­¥ï¼ŒWebSocket å®æ—¶æ¨é€è¿›åº¦
- **å®ç°**: `POST /bot-config` è¿”å›åç«‹å³è§¦å‘å¼‚æ­¥ä»»åŠ¡

---

### é˜¶æ®µ 2: åˆ›å»ºåˆ†å‘è§„åˆ™

```
â”Œâ”€ ç”¨æˆ·æ“ä½œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                â”‚
â”‚ 1. æ‰“å¼€"å®¡æ‰¹ä¸åˆ†å‘" â†’ "å†…å®¹é˜Ÿåˆ—"æ ‡ç­¾            â”‚
â”‚                                                â”‚
â”‚ 2. å·¦ä¾§è§„åˆ™åˆ—è¡¨ â†’ ç‚¹å‡»"æ–°å»ºè§„åˆ™"                â”‚
â”‚                                                â”‚
â”‚ 3. å¡«å†™è§„åˆ™é…ç½®ï¼š                               â”‚
â”‚    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”‚
â”‚    åŸºç¡€ä¿¡æ¯ï¼š                                   â”‚
â”‚      [è¾“å…¥æ¡†] è§„åˆ™åç§°: "ç§‘æŠ€æ–°é—»"              â”‚
â”‚      [æ–‡æœ¬åŸŸ] æè¿°: "AI/ç¼–ç¨‹ç›¸å…³å†…å®¹"           â”‚
â”‚                                                â”‚
â”‚    æ ‡ç­¾åŒ¹é…ï¼š                                   â”‚
â”‚      [æ ‡ç­¾è¾“å…¥] åŒ…å«: AI, ç¼–ç¨‹, LLM            â”‚
â”‚      [ä¸‹æ‹‰æ¡†] åŒ¹é…æ¨¡å¼: åŒ…å«ä»»ä¸€ â–¼             â”‚
â”‚      [æ ‡ç­¾è¾“å…¥] æ’é™¤: å¹¿å‘Š, è¥é”€               â”‚
â”‚                                                â”‚
â”‚    åˆ†å‘ç­–ç•¥ï¼š                                   â”‚
â”‚      [åˆ†æ®µæŒ‰é’®] NSFW: âšªé˜»æ­¢ âšªå…è®¸ âšªåˆ†ç¦»      â”‚
â”‚      [æ•°å­—æ¡†] ä¼˜å…ˆçº§: 5                        â”‚
â”‚      [å¼€å…³] éœ€è¦äººå·¥å®¡æ‰¹: OFF                   â”‚
â”‚                                                â”‚
â”‚    ğŸ†• æ¨é€ç›®æ ‡ï¼ˆæ–°å¢åŠŸèƒ½ï¼‰ï¼š                     â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚      â”‚ â˜‘ @TechNewsChannel (Telegram)   â”‚     â”‚
â”‚      â”‚ â˜‘ AIå­¦ä¹ ç¾¤ (QQ: 123456789)      â”‚     â”‚
â”‚      â”‚ â˜ ç§äººé¢‘é“ (Telegram)           â”‚     â”‚
â”‚      â”‚                                 â”‚     â”‚
â”‚      â”‚ [ğŸ“‹ å…¨é€‰] [ğŸ”„ åˆ·æ–°åˆ—è¡¨]          â”‚     â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                â”‚
â”‚    æ¸²æŸ“é…ç½®ï¼ˆå…¨å±€ï¼‰ï¼š                            â”‚
â”‚      [ä¸‹æ‹‰æ¡†] é¢„è®¾æ¨¡æ¿: ç®€æ´é£æ ¼ â–¼             â”‚
â”‚      [åˆ‡æ¢] é«˜çº§é€‰é¡¹...                        â”‚
â”‚                                                â”‚
â”‚    ğŸ’¡ å¿«é€Ÿæ“ä½œï¼š                                â”‚
â”‚      [ğŸ“‹ Forkæ­¤è§„åˆ™] - å¿«é€Ÿåˆ›å»ºå˜ä½“            â”‚
â”‚                                                â”‚
â”‚ 4. [åˆ›å»ºè§„åˆ™] æŒ‰é’®                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
       POST /api/v1/distribution-rules
       {
         "name": "ç§‘æŠ€æ–°é—»",
         "match_conditions": {
           "tags": ["AI", "ç¼–ç¨‹", "LLM"],
           "tags_match_mode": "any",
           "tags_exclude": ["å¹¿å‘Š", "è¥é”€"]
         },
         "nsfw_policy": "block",
         "priority": 5,
         "approval_required": false,
         "render_config": {
           "layout": "card",
           "show_author": true,
           "show_tags": true
         },
         "targets": [  // ğŸ†• æ‰¹é‡åˆ›å»ºå…³è”
           {
             "bot_chat_id": 1,
             "enabled": true
           },
           {
             "bot_chat_id": 3,
             "enabled": true,
             "merge_forward": true
           }
         ]
       }
```

**ğŸ’¡ ä¼˜åŒ–ç‚¹ 2: ä¸€é”®å…³è”ç›®æ ‡**
- **å½“å‰ç—›ç‚¹**: è§„åˆ™å’Œç›®æ ‡éœ€åˆ†ä¸¤æ­¥é…ç½®
- **ä¼˜åŒ–æ–¹æ¡ˆ**: åœ¨åˆ›å»ºè§„åˆ™æ—¶ç›´æ¥å‹¾é€‰ç›®æ ‡ç¾¤ç»„ï¼ˆå¦‚ä¸Šè®¾è®¡ï¼‰
- **æŠ€æœ¯å®ç°**: 
  - å‰ç«¯: `DistributionRuleDialog` ä¸­åµŒå…¥ `BotChatSelector` ç»„ä»¶
  - åç«¯: `POST /distribution-rules` æ”¯æŒåµŒå¥— `targets` æ•°ç»„

---

### é˜¶æ®µ 3: æ·»åŠ å†…å®¹åˆ°é˜Ÿåˆ—

#### æ–¹å¼ A: æ‰‹åŠ¨æ·»åŠ 

```
â”Œâ”€ ç”¨æˆ·æ“ä½œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                              â”‚
â”‚ 1. æ‰“å¼€"æ”¶è—åº“"é¡µé¢                           â”‚
â”‚                                              â”‚
â”‚ 2. æ‰¾åˆ°æƒ³åˆ†å‘çš„å†…å®¹å¡ç‰‡                       â”‚
â”‚                                              â”‚
â”‚ 3. ç‚¹å‡»å¡ç‰‡å³ä¸Šè§’ [â‹®] â†’ "åŠ å…¥åˆ†å‘é˜Ÿåˆ—"        â”‚
â”‚                                              â”‚
â”‚ 4. å¼¹çª—æ˜¾ç¤ºåŒ¹é…ç»“æœï¼š                         â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚    â”‚ "è¯¥å†…å®¹åŒ¹é…ä»¥ä¸‹è§„åˆ™ï¼š"          â”‚       â”‚
â”‚    â”‚                                â”‚       â”‚
â”‚    â”‚ âœ“ ç§‘æŠ€æ–°é—» (ä¼˜å…ˆçº§: 5)         â”‚       â”‚
â”‚    â”‚   â†’ æ¨é€åˆ° 2 ä¸ªç›®æ ‡             â”‚       â”‚
â”‚    â”‚                                â”‚       â”‚
â”‚    â”‚ âœ“ AIåŠ¨æ€ (éœ€è¦å®¡æ‰¹)            â”‚       â”‚
â”‚    â”‚   â†’ æ¨é€åˆ° 3 ä¸ªç›®æ ‡             â”‚       â”‚
â”‚    â”‚                                â”‚       â”‚
â”‚    â”‚ [ç«‹å³åŠ å…¥é˜Ÿåˆ—] [å–æ¶ˆ]           â”‚       â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ–¹å¼ B: è‡ªåŠ¨åŒ¹é…ï¼ˆåå°ï¼‰

##### æ ¸å¿ƒæ¶æ„ï¼šä¸‰å…ƒç»„é˜Ÿåˆ—æ¨¡å‹

**âš ï¸ æ¶æ„ç¼ºé™·åˆ†æ**ï¼š
- **å½“å‰ç—›ç‚¹**: ä½¿ç”¨ `Content.status` æ¨¡æ‹Ÿé˜Ÿåˆ—ï¼Œæ— æ³•ç»†ç²’åº¦è·Ÿè¸ªå¤šè§„åˆ™æ¨é€
  ```python
  # åœºæ™¯ï¼šContent A åŒ¹é…äº†è§„åˆ™1å’Œè§„åˆ™2
  - è§„åˆ™1 â†’ æ¨é€åˆ° ç¾¤ç»„X, ç¾¤ç»„Y (æˆåŠŸ)
  - è§„åˆ™2 â†’ æ¨é€åˆ° ç¾¤ç»„Y, ç¾¤ç»„Z (å¤±è´¥)
  
  # é—®é¢˜ï¼šContent A åº”è¯¥æ ‡è®°ä¸ºä»€ä¹ˆçŠ¶æ€ï¼Ÿ
  # å½“å‰æ¨¡å‹åªèƒ½äºŒé€‰ä¸€ï¼Œå¯¼è‡´ä¿¡æ¯ä¸¢å¤±
  ```

**âœ… æ”¹è¿›æ–¹æ¡ˆï¼šContentQueueItem ä¸‰å…ƒç»„æ¨¡å‹**

æ¯ä¸ªé˜Ÿåˆ—é¡¹ä»£è¡¨å”¯ä¸€çš„ `(Content Ã— Rule Ã— BotChat)` ç»„åˆï¼š

```python
class ContentQueueItem(Base):
    """
    å†…å®¹é˜Ÿåˆ—é¡¹ - ä¸€ä¸ª Content å¯ä»¥åŒ¹é…å¤šä¸ª Ruleï¼Œ
    ä¸€ä¸ª Rule å¯ä»¥æ¨é€åˆ°å¤šä¸ª BotChatï¼Œ
    æ¯ä¸ªç»„åˆæ˜¯ç‹¬ç«‹çš„é˜Ÿåˆ—é¡¹ï¼Œæ‹¥æœ‰ç‹¬ç«‹çš„çŠ¶æ€
    """
    __tablename__ = "content_queue_items"
    
    id = Column(Integer, primary_key=True)
    
    # ä¸‰å…ƒç»„å…³è”
    content_id = Column(Integer, ForeignKey("contents.id"), nullable=False)
    rule_id = Column(Integer, ForeignKey("distribution_rules.id"), nullable=False)
    bot_chat_id = Column(Integer, ForeignKey("bot_chats.id"), nullable=False)
    
    # ç»†ç²’åº¦çŠ¶æ€
    status = Column(Enum(  # pending, scheduled, pushing, success, failed, skipped
        QueueItemStatus), default="pending")
    scheduled_at = Column(DateTime)  # è®¡åˆ’æ¨é€æ—¶é—´
    
    # ğŸ¯ é¢„å¤„ç†ç¼“å­˜ï¼ˆé¿å…æ¨é€æ—¶é‡å¤è®¡ç®—ï¼‰
    rendered_payload = Column(JSON)  # é¢„æ¸²æŸ“ç»“æœ
    nsfw_routing_result = Column(JSON)  # NSFW è·¯ç”±å†³ç­–
    passed_rate_limit = Column(Boolean, default=True)  # é¢‘ç‡é™åˆ¶æ£€æŸ¥
    
    # å®¡æ‰¹æµç¨‹
    needs_approval = Column(Boolean, default=False)
    approved_at = Column(DateTime)
    approved_by = Column(String(100))
    
    # æ¨é€ç»“æœ
    pushed_at = Column(DateTime)
    message_id = Column(String(200))  # æ¶ˆæ¯IDï¼ˆç”¨äºæ’¤å›/ç¼–è¾‘ï¼‰
    error_message = Column(Text)
    retry_count = Column(Integer, default=0)
    max_retries = Column(Integer, default=3)
    next_retry_at = Column(DateTime)
    
    # ç¡®ä¿å”¯ä¸€æ€§
    __table_args__ = (
        UniqueConstraint("content_id", "rule_id", "bot_chat_id"),
    )
```

##### äº‹ä»¶é©±åŠ¨å…¥é˜Ÿæµç¨‹

**ğŸ’¡ ä¼˜åŒ–ç‚¹ 3: äº‹ä»¶é©±åŠ¨æ›¿ä»£å®šæ—¶ä»»åŠ¡**
- **å½“å‰ç—›ç‚¹**: ä¾èµ–å®šæ—¶ä»»åŠ¡ï¼Œå»¶è¿Ÿé«˜ï¼ˆæœ€é•¿ 1 åˆ†é’Ÿï¼‰
- **ä¼˜åŒ–æ–¹æ¡ˆ**: Content åˆ›å»ºåç«‹å³è§¦å‘åŒ¹é…
- **æŠ€æœ¯å®ç°**:
  ```python
  # ===== æ­¥éª¤ 1: ç›‘å¬ Content å˜åŒ– =====
  @event.listens_for(Content, 'after_insert')
  @event.listens_for(Content, 'after_update')
  async def on_content_changed(mapper, connection, target):
      if target.status == ContentStatus.PULLED:
          # ç«‹å³å¼‚æ­¥è§¦å‘å…¥é˜Ÿï¼ˆä¸é˜»å¡ä¸»æµç¨‹ï¼‰
          background_tasks.add_task(enqueue_content, target.id)
  
  
  # ===== æ­¥éª¤ 2: å…¥é˜Ÿé€»è¾‘ï¼ˆä¸€æ¬¡æ€§å®Œæˆæ‰€æœ‰é¢„å¤„ç†ï¼‰=====
  async def enqueue_content(content_id: int):
      """
      èŒè´£ï¼š
      1. åŒ¹é…è§„åˆ™
      2. NSFW è·¯ç”±å†³ç­–
      3. é¢‘ç‡é™åˆ¶æ£€æŸ¥
      4. é¢„æ¸²æŸ“å†…å®¹
      5. è®¡ç®—æ’æœŸæ—¶é—´
      6. åˆ›å»ºé˜Ÿåˆ—é¡¹
      """
      async with AsyncSessionLocal() as db:
          content = await db.get(Content, content_id)
          
          # 1. åŒ¹é…æ‰€æœ‰å¯ç”¨çš„è§„åˆ™
          matched_rules = await match_rules(db, content)
          if not matched_rules:
              return
          
          # 2. è·å–è§„åˆ™çš„ç›®æ ‡ç¾¤ç»„ï¼ˆæ‰¹é‡æŸ¥è¯¢é¿å… N+1ï¼‰
          rule_ids = [r.id for r in matched_rules]
          targets = await db.execute(
              select(DistributionTarget, BotChat)
              .join(BotChat)
              .where(DistributionTarget.rule_id.in_(rule_ids))
              .where(DistributionTarget.enabled == True)
              .where(BotChat.enabled == True)
          )
          
          # 3. ä¸ºæ¯ä¸ª (Rule, BotChat) ç»„åˆåˆ›å»ºé˜Ÿåˆ—é¡¹
          for rule in matched_rules:
              for target, bot_chat in targets:
                  # æ£€æŸ¥å»é‡
                  existing = await db.execute(
                      select(ContentQueueItem).where(
                          ContentQueueItem.content_id == content.id,
                          ContentQueueItem.rule_id == rule.id,
                          ContentQueueItem.bot_chat_id == bot_chat.id,
                      )
                  )
                  if existing.scalar_one_or_none():
                      continue
                  
                  # NSFW è·¯ç”±å†³ç­–
                  nsfw_result = await apply_nsfw_routing(content, rule, bot_chat)
                  if not nsfw_result["allowed"]:
                      # åˆ›å»º SKIPPED çŠ¶æ€é˜Ÿåˆ—é¡¹ï¼ˆè®°å½•åŸå› ï¼‰
                      queue_item = ContentQueueItem(
                          content_id=content.id,
                          rule_id=rule.id,
                          bot_chat_id=bot_chat.id,
                          status=QueueItemStatus.SKIPPED,
                          nsfw_routing_result=nsfw_result,
                      )
                      db.add(queue_item)
                      continue
                  
                  # é¢‘ç‡é™åˆ¶æ£€æŸ¥
                  rate_ok, reason = await check_rate_limit(db, rule, bot_chat)
                  
                  # ğŸ¯ é¢„æ¸²æŸ“å†…å®¹ï¼ˆé¿å…æ¨é€æ—¶é‡å¤æ¸²æŸ“ï¼‰
                  rendered = await render_content(content, rule, target, bot_chat)
                  
                  # è®¡ç®—æ’æœŸæ—¶é—´
                  scheduled_at = await calculate_schedule(
                      db, content, rule,
                      immediate=(content.review_status == ReviewStatus.APPROVED)
                  )
                  
                  # åˆ›å»ºé˜Ÿåˆ—é¡¹
                  queue_item = ContentQueueItem(
                      content_id=content.id,
                      rule_id=rule.id,
                      bot_chat_id=bot_chat.id,
                      status=QueueItemStatus.SCHEDULED if rate_ok else QueueItemStatus.PENDING,
                      scheduled_at=scheduled_at,
                      rendered_payload=rendered,  # ç¼“å­˜æ¸²æŸ“ç»“æœ
                      nsfw_routing_result=nsfw_result,
                      passed_rate_limit=rate_ok,
                      rate_limit_reason=reason if not rate_ok else None,
                      needs_approval=(rule.approval_required and 
                                     content.review_status == ReviewStatus.PENDING),
                  )
                  db.add(queue_item)
          
          await db.commit()
  ```

**âœ… ä¼˜åŠ¿å¯¹æ¯”**ï¼š

| å¯¹æ¯”ç»´åº¦ | å®šæ—¶ä»»åŠ¡æ–¹æ¡ˆ | äº‹ä»¶é©±åŠ¨ + é˜Ÿåˆ—æ¨¡å‹ |
|---------|------------|------------------|
| **å“åº”å»¶è¿Ÿ** | 0-60ç§’ | å®æ—¶ï¼ˆ<1ç§’ï¼‰ |
| **èŒè´£åˆ†ç¦»** | âŒ æ··ä¹±ï¼ˆè°ƒåº¦å™¨åšæ‰€æœ‰äº‹ï¼‰ | âœ… æ¸…æ™°ï¼ˆå…¥é˜Ÿ/æ¨é€åˆ†ç¦»ï¼‰ |
| **é‡å¤è®¡ç®—** | âŒ æ¯æ¬¡æ¨é€éƒ½é‡æ–°åŒ¹é…è§„åˆ™ | âœ… å…¥é˜Ÿæ—¶ç®—ä¸€æ¬¡ï¼Œç¼“å­˜ç»“æœ |
| **çŠ¶æ€ç®¡ç†** | âŒ Content çº§åˆ«ï¼ˆç²—ç²’åº¦ï¼‰ | âœ… ä¸‰å…ƒç»„çº§åˆ«ï¼ˆç»†ç²’åº¦ï¼‰ |
| **å¹¶å‘æ¨é€** | âŒ éš¾ä»¥å®ç° | âœ… å¤š worker å¤©ç„¶æ”¯æŒ |
| **å¤±è´¥é‡è¯•** | âŒ æ— æœºåˆ¶ | âœ… æŒ‡æ•°é€€é¿è‡ªåŠ¨é‡è¯• |

---

### é˜¶æ®µ 4: å®¡æ‰¹æµç¨‹ï¼ˆå¯é€‰ï¼‰

```
å¦‚æœè§„åˆ™å¯ç”¨äº† approval_required:

â”Œâ”€ ç”¨æˆ·æ“ä½œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                          â”‚
â”‚ 1. æ‰“å¼€"å®¡æ‰¹ä¸åˆ†å‘" â†’ é¡¶éƒ¨çŠ¶æ€ç­›é€‰å™¨        â”‚
â”‚    ç‚¹å‡» [å¾…å®¡æ‰¹ (3)]                      â”‚
â”‚                                          â”‚
â”‚ 2. æŸ¥çœ‹å†…å®¹å¡ç‰‡ï¼š                         â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚    â”‚ [å°é¢ç¼©ç•¥å›¾]                  â”‚     â”‚
â”‚    â”‚                               â”‚     â”‚
â”‚    â”‚ æ ‡é¢˜: "GPT-5 å‘å¸ƒä¼šå›é¡¾"       â”‚     â”‚
â”‚    â”‚ æ ‡ç­¾: AI, GPT, ç§‘æŠ€           â”‚     â”‚
â”‚    â”‚ æ¥æº: Bilibili                â”‚     â”‚
â”‚    â”‚                               â”‚     â”‚
â”‚    â”‚ åŒ¹é…è§„åˆ™:                      â”‚     â”‚
â”‚    â”‚   â€¢ ç§‘æŠ€æ–°é—» â†’ 2ä¸ªç›®æ ‡         â”‚     â”‚
â”‚    â”‚   â€¢ AIåŠ¨æ€ â†’ 3ä¸ªç›®æ ‡           â”‚     â”‚
â”‚    â”‚                               â”‚     â”‚
â”‚    â”‚ [âœ“ æ‰¹å‡†] [âœ— æ‹’ç»]            â”‚     â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                          â”‚
â”‚ 3. ç‚¹å‡» [æ‰¹å‡†]                           â”‚
â”‚    â†’ è°ƒç”¨ PATCH /queue/{id}              â”‚
â”‚    â†’ status: pending_review â†’ will_push â”‚
â”‚    â†’ è¿›å…¥æ’æœŸé˜Ÿåˆ—                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### é˜¶æ®µ 5: è‡ªåŠ¨åˆ†å‘æ‰§è¡Œ

##### æ¨é€ Worker æ¶æ„ï¼ˆèŒè´£åˆ†ç¦»ï¼‰

**âš ï¸ æ¶æ„ç¼ºé™·åˆ†æ**ï¼š
- **å½“å‰ç—›ç‚¹**: 
  - è½®è¯¢å»¶è¿Ÿ 30-60 ç§’
  - æ¯æ¬¡æ¨é€é‡æ–°åŒ¹é…è§„åˆ™ã€æ£€æŸ¥ NSFWã€æ¸²æŸ“å†…å®¹ï¼ˆé‡å¤è®¡ç®—ï¼‰
  - è°ƒåº¦å™¨èŒè´£æ··ä¹±ï¼ˆæ—¢åšä¸šåŠ¡åˆ¤æ–­åˆåšæ¨é€ï¼‰
  - æ— æ³•æ”¯æŒå¤š worker å¹¶å‘æ¨é€

**âœ… æ”¹è¿›æ–¹æ¡ˆï¼šäº‹ä»¶é©±åŠ¨ + èŒè´£å•ä¸€çš„ Worker**

```python
async def distribution_worker():
    """
    æ¨é€ Workerï¼šåªè´Ÿè´£å‘é€ï¼Œä¸åšä¸šåŠ¡åˆ¤æ–­
    
    èŒè´£ï¼š
    1. æŸ¥è¯¢åˆ°æœŸçš„é˜Ÿåˆ—é¡¹
    2. è°ƒç”¨æ¨é€æœåŠ¡å‘é€ï¼ˆä½¿ç”¨é¢„æ¸²æŸ“ç»“æœï¼‰
    3. æ›´æ–°é˜Ÿåˆ—é¡¹çŠ¶æ€
    4. å¤±è´¥è‡ªåŠ¨é‡è¯•ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
    """
    while True:
        try:
            async with AsyncSessionLocal() as db:
                # æŸ¥è¯¢åˆ°æœŸä¸”å…è®¸æ¨é€çš„é˜Ÿåˆ—é¡¹
                now = datetime.utcnow()
                result = await db.execute(
                    select(ContentQueueItem)
                    .where(
                        ContentQueueItem.status == QueueItemStatus.SCHEDULED,
                        ContentQueueItem.scheduled_at <= now,
                        ContentQueueItem.passed_rate_limit == True,
                        ContentQueueItem.needs_approval == False,  # æ— éœ€å®¡æ‰¹æˆ–å·²å®¡æ‰¹
                    )
                    .order_by(ContentQueueItem.scheduled_at.asc())
                    .limit(10)  # æ‰¹é‡å¤„ç†
                )
                items = result.scalars().all()
                
                if not items:
                    await asyncio.sleep(5)  # çŸ­è½®è¯¢ï¼ˆæˆ–ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼‰
                    continue
                
                for item in items:
                    # æ ‡è®°ä¸ºæ¨é€ä¸­ï¼ˆé¿å…é‡å¤æ¨é€ï¼‰
                    item.status = QueueItemStatus.PUSHING
                    await db.commit()
                    
                    try:
                        # è·å–å…³è”æ•°æ®
                        await db.refresh(item, ["content", "rule", "bot_chat"])
                        
                        # ç¡®å®šå®é™…æ¨é€ç›®æ ‡ï¼ˆå¯èƒ½è¢« NSFW è·¯ç”±äº†ï¼‰
                        target_chat_id = item.nsfw_routing_result.get(
                            "routed_to", 
                            item.bot_chat.chat_id
                        )
                        
                        # ğŸ¯ è°ƒç”¨æ¨é€æœåŠ¡ï¼ˆç›´æ¥ä½¿ç”¨é¢„æ¸²æŸ“ç»“æœï¼‰
                        push_service = get_push_service(item.bot_chat.platform_type)
                        message_id = await push_service.send(
                            chat_id=target_chat_id,
                            payload=item.rendered_payload,  # ä½¿ç”¨ç¼“å­˜
                        )
                        
                        # æ›´æ–°ä¸ºæˆåŠŸ
                        item.status = QueueItemStatus.SUCCESS
                        item.message_id = message_id
                        item.pushed_at = datetime.utcnow()
                        
                        # åŒæ­¥æ›´æ–° BotChat ç»Ÿè®¡
                        item.bot_chat.total_pushed += 1
                        item.bot_chat.last_pushed_at = item.pushed_at
                        
                        logger.info(
                            f"âœ… Pushed: content={item.content_id}, "
                            f"rule={item.rule_id}, chat={target_chat_id}, msg_id={message_id}"
                        )
                        
                    except Exception as e:
                        logger.error(f"âŒ Push failed: {e}", exc_info=True)
                        
                        # åˆ¤æ–­æ˜¯å¦å¯é‡è¯•
                        item.retry_count += 1
                        if item.retry_count < item.max_retries:
                            item.status = QueueItemStatus.SCHEDULED
                            # æŒ‡æ•°é€€é¿é‡è¯•ï¼ˆ2^n åˆ†é’Ÿï¼‰
                            retry_delay = 60 * (2 ** item.retry_count)
                            item.next_retry_at = datetime.utcnow() + timedelta(seconds=retry_delay)
                            item.scheduled_at = item.next_retry_at
                            item.error_message = str(e)
                            logger.info(f"ğŸ”„ Retry {item.retry_count}/{item.max_retries} in {retry_delay}s")
                        else:
                            item.status = QueueItemStatus.FAILED
                            item.error_message = f"Failed after {item.max_retries} retries: {e}"
                    
                    await db.commit()
        
        except Exception as e:
            logger.error(f"Worker error: {e}", exc_info=True)
            await asyncio.sleep(10)


# ===== å¯åŠ¨å¤šä¸ªå¹¶å‘ Worker =====
@app.on_event("startup")
async def startup_event():
    # 3 ä¸ªå¹¶å‘ worker å®ç°å¹¶å‘æ¨é€
    for i in range(3):
        asyncio.create_task(distribution_worker(), name=f"push-worker-{i}")
```

**æ‰§è¡Œæµç¨‹å¯è§†åŒ–**ï¼š

```
â”Œâ”€ æ¨é€ Worker (å¹¶å‘3ä¸ª) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                              â”‚
â”‚ å®šæ—¶è§¦å‘: æ¯ 5 ç§’æ£€æŸ¥ä¸€æ¬¡                       â”‚
â”‚                                              â”‚
â”‚ 1. æŸ¥è¯¢å¾…æ¨é€é˜Ÿåˆ—é¡¹:                           â”‚
â”‚    SELECT * FROM content_queue_items         â”‚
â”‚    WHERE status='scheduled'                 â”‚
â”‚      AND scheduled_at <= NOW()              â”‚
â”‚      AND passed_rate_limit=true             â”‚
â”‚      AND needs_approval=false               â”‚
â”‚    LIMIT 10                                 â”‚
â”‚                                              â”‚
â”‚ 2. å¯¹æ¯ä¸ªé˜Ÿåˆ—é¡¹:                              â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚    â”‚ a) æ ‡è®°ä¸º PUSHING (é¿å…å¹¶å‘å†²çª)     â”‚ â”‚
â”‚    â”‚                                     â”‚ â”‚
â”‚    â”‚ b) è¯»å–é¢„æ¸²æŸ“ç»“æœ:                   â”‚ â”‚
â”‚    â”‚    payload = item.rendered_payload  â”‚ â”‚
â”‚    â”‚    (âœ… æ— éœ€é‡æ–°æ¸²æŸ“)                 â”‚ â”‚
â”‚    â”‚                                     â”‚ â”‚
â”‚    â”‚ c) åº”ç”¨ NSFW è·¯ç”±:                   â”‚ â”‚
â”‚    â”‚    target = nsfw_result["routed_to"]â”‚ â”‚
â”‚    â”‚    (âœ… å…¥é˜Ÿæ—¶å·²å†³ç­–)                 â”‚ â”‚
â”‚    â”‚                                     â”‚ â”‚
â”‚    â”‚ d) è°ƒç”¨æ¨é€æœåŠ¡:                     â”‚ â”‚
â”‚    â”‚    message_id = await               â”‚ â”‚
â”‚    â”‚      push_service.send(payload)     â”‚ â”‚
â”‚    â”‚                                     â”‚ â”‚
â”‚    â”‚ e) æ›´æ–°çŠ¶æ€:                         â”‚ â”‚
â”‚    â”‚    æˆåŠŸ â†’ status=SUCCESS            â”‚ â”‚
â”‚    â”‚          + è®°å½• message_id          â”‚ â”‚
â”‚    â”‚    å¤±è´¥ â†’ é‡è¯•æ¬¡æ•°+1                â”‚ â”‚
â”‚    â”‚          + æŒ‡æ•°é€€é¿æ’æœŸ              â”‚ â”‚
â”‚    â”‚          + è¶…è¿‡ä¸Šé™æ ‡ FAILED         â”‚ â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**âœ… ä¼˜åŠ¿å¯¹æ¯”**ï¼š

| å¯¹æ¯”ç»´åº¦ | å½“å‰è½®è¯¢æ–¹æ¡ˆ | äº‹ä»¶é©±åŠ¨ + Worker |
|---------|------------|------------------|
| **æ¨é€å»¶è¿Ÿ** | 0-30ç§’ | å®æ—¶ï¼ˆ<5ç§’ï¼‰ |
| **é‡å¤è®¡ç®—** | âŒ æ¯æ¬¡éƒ½é‡æ–°åŒ¹é…è§„åˆ™ã€æ£€æŸ¥ NSFWã€æ¸²æŸ“å†…å®¹ | âœ… å…¥é˜Ÿæ—¶åšä¸€æ¬¡ï¼Œç¼“å­˜ç»“æœ |
| **å¹¶å‘èƒ½åŠ›** | âŒ å•çº¿ç¨‹é¡ºåºæ¨é€ | âœ… å¤š worker å¹¶å‘ï¼ˆå¯æ‰©å±•ï¼‰ |
| **å¤±è´¥é‡è¯•** | âŒ æ— è‡ªåŠ¨é‡è¯• | âœ… æŒ‡æ•°é€€é¿è‡ªåŠ¨é‡è¯• |
| **çŠ¶æ€è¿½æº¯** | âš ï¸ ç²—ç²’åº¦ï¼ˆContent çº§åˆ«ï¼‰ | âœ… ç»†ç²’åº¦ï¼ˆæ¯ä¸ªæ¨é€ä»»åŠ¡ç‹¬ç«‹ï¼‰ |
| **æ¨é€å†å²** | âš ï¸ PushedRecord ç¼º rule_id | âœ… é˜Ÿåˆ—é¡¹è‡ªåŠ¨åŒ…å«å®Œæ•´å…ƒæ•°æ® |

---

### é˜¶æ®µ 6: ç›‘æ§ä¸è°ƒæ•´

```
â”Œâ”€ ç”¨æˆ·æ“ä½œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                              â”‚
â”‚ 1. æ‰“å¼€"å®¡æ‰¹ä¸åˆ†å‘" â†’ "æ¨é€å†å²"æ ‡ç­¾          â”‚
â”‚                                              â”‚
â”‚ 2. æŸ¥çœ‹æ¨é€è®°å½•ï¼š                             â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚    â”‚ [âœ“] GPT-5 å‘å¸ƒä¼š               â”‚       â”‚
â”‚    â”‚    â€¢ @TechNewsChannel (TG)     â”‚       â”‚
â”‚    â”‚      12:30 æˆåŠŸ                 â”‚       â”‚
â”‚    â”‚    â€¢ AIå­¦ä¹ ç¾¤ (QQ: 123456)     â”‚       â”‚
â”‚    â”‚      12:30 æˆåŠŸ                 â”‚       â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚
â”‚    â”‚ [âœ—] Claude 3.5 è¯„æµ‹            â”‚       â”‚
â”‚    â”‚    â€¢ ç§äººé¢‘é“ (TG)              â”‚       â”‚
â”‚    â”‚      12:31 å¤±è´¥: æ— æƒé™         â”‚       â”‚
â”‚    â”‚      [ğŸ”„ é‡è¯•]                  â”‚       â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                              â”‚
â”‚ 3. æ‰“å¼€"ç›®æ ‡ç®¡ç†"é¡µé¢ï¼š                        â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚    â”‚ [Telegram] @TechNewsChannel    â”‚       â”‚
â”‚    â”‚ åº”ç”¨è§„åˆ™: ç§‘æŠ€æ–°é—», AIåŠ¨æ€       â”‚       â”‚
â”‚    â”‚ æ€»æ¨é€: 1,234 æ¬¡                â”‚       â”‚
â”‚    â”‚ æœ€åæ¨é€: 2åˆ†é’Ÿå‰                â”‚       â”‚
â”‚    â”‚                                â”‚       â”‚
â”‚    â”‚ [âš™ï¸ é…ç½®è§„åˆ™] [ğŸ“Š æŸ¥çœ‹ç»Ÿè®¡]     â”‚       â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                              â”‚
â”‚ 4. ç‚¹å‡»"é…ç½®è§„åˆ™"å¼¹çª—ï¼š                        â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚    â”‚ ä¸º @TechNewsChannel é€‰æ‹©è§„åˆ™:   â”‚       â”‚
â”‚    â”‚                                â”‚       â”‚
â”‚    â”‚ â˜‘ ç§‘æŠ€æ–°é—»                      â”‚       â”‚
â”‚    â”‚   â””â”€ [âš™ï¸] è‡ªå®šä¹‰æ¸²æŸ“é…ç½®        â”‚       â”‚
â”‚    â”‚ â˜‘ AIåŠ¨æ€                        â”‚       â”‚
â”‚    â”‚ â˜ å¼€æºé¡¹ç›®                      â”‚       â”‚
â”‚    â”‚ â˜ äº§å“æ¨è (å·²ç¦ç”¨)             â”‚       â”‚
â”‚    â”‚                                â”‚       â”‚
â”‚    â”‚ [ä¿å­˜] [å–æ¶ˆ]                   â”‚       â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ğŸ¯ æ¨é€å†å²å®Œæ•´æ€§ä¿éšœ

**âš ï¸ å½“å‰ PushedRecord ç¼ºé™·**ï¼š
```python
# ç°æœ‰æ¨¡å‹ä¿¡æ¯ä¸è¶³
class PushedRecord(Base):
    content_id: int
    target_platform: str  # "telegram"
    target_id: str        # "@channel"
    message_id: str
    push_status: str
    
    # âŒ ç¼ºå°‘ï¼š
    # - rule_id: ä¸çŸ¥é“å“ªä¸ªè§„åˆ™è§¦å‘çš„
    # - rendered_config: ä¸çŸ¥é“ç”¨çš„ä»€ä¹ˆæ¸²æŸ“é…ç½®
    # - retry_info: ä¸çŸ¥é“é‡è¯•äº†å‡ æ¬¡
```

**âœ… é˜Ÿåˆ—æ¨¡å‹è‡ªåŠ¨åŒ…å«å®Œæ•´å…ƒæ•°æ®**ï¼š

é‡‡ç”¨ `ContentQueueItem` åï¼Œæ¨é€å†å²è‡ªåŠ¨å®Œæ•´ï¼š

```sql
-- æŸ¥è¯¢ç¤ºä¾‹ 1: æŸå†…å®¹çš„å®Œæ•´æ¨é€å†å²
SELECT 
    c.title,
    r.name AS rule_name,
    bc.title AS chat_name,
    q.status,
    q.pushed_at,
    q.message_id,
    q.retry_count,
    q.error_message
FROM content_queue_items q
JOIN contents c ON c.id = q.content_id
JOIN distribution_rules r ON r.id = q.rule_id
JOIN bot_chats bc ON bc.id = q.bot_chat_id
WHERE q.content_id = 123
ORDER BY q.created_at DESC;

-- æŸ¥è¯¢ç¤ºä¾‹ 2: æŸè§„åˆ™çš„æ¨é€æ•ˆæœç»Ÿè®¡
SELECT 
    r.name,
    COUNT(CASE WHEN q.status = 'success' THEN 1 END) AS success_count,
    COUNT(CASE WHEN q.status = 'failed' THEN 1 END) AS failed_count,
    AVG(TIMESTAMPDIFF(SECOND, q.created_at, q.pushed_at)) AS avg_delay_seconds
FROM content_queue_items q
JOIN distribution_rules r ON r.id = q.rule_id
WHERE r.id = 5
GROUP BY r.id;

-- æŸ¥è¯¢ç¤ºä¾‹ 3: æŸç¾¤ç»„çš„æ¥æ”¶å†…å®¹å†å²
SELECT 
    c.title,
    c.url,
    r.name AS from_rule,
    q.pushed_at,
    q.message_id
FROM content_queue_items q
JOIN contents c ON c.id = q.content_id
JOIN distribution_rules r ON r.id = q.rule_id
WHERE q.bot_chat_id = 10 AND q.status = 'success'
ORDER BY q.pushed_at DESC
LIMIT 50;
```

---

## å››ã€å…³é”®ä¼˜åŒ–ç‚¹

### ğŸš¨ é«˜ä¼˜å…ˆçº§ä¼˜åŒ–ï¼ˆæ¶æ„æ ¸å¿ƒä¿®å¤ï¼‰

#### 1. å¼•å…¥ä¸‰å…ƒç»„é˜Ÿåˆ—æ¨¡å‹ (ContentQueueItem)

**ğŸ”´ æ ¸å¿ƒç¼ºé™·**ï¼š
- **å½“å‰é—®é¢˜**: ä½¿ç”¨ `Content.status` æ¨¡æ‹Ÿé˜Ÿåˆ—ï¼Œæ— æ³•å¤„ç†å¤šè§„åˆ™æ¨é€
- **å…¸å‹åœºæ™¯**:
  ```python
  # Content A åŒ¹é…äº†è§„åˆ™1å’Œè§„åˆ™2
  - è§„åˆ™1 â†’ æ¨é€åˆ° ç¾¤ç»„X, ç¾¤ç»„Y (æˆåŠŸ)
  - è§„åˆ™2 â†’ æ¨é€åˆ° ç¾¤ç»„Y, ç¾¤ç»„Z (å¤±è´¥)
  
  # âŒ é—®é¢˜ï¼šContent A åº”è¯¥æ ‡è®°ä¸ºä»€ä¹ˆçŠ¶æ€ï¼Ÿ
  # å½“å‰æ¨¡å‹åªèƒ½äºŒé€‰ä¸€ï¼Œå¯¼è‡´ä¿¡æ¯ä¸¢å¤±ï¼š
  Content.status = "distributed"  # ä¸¢å¤±äº†è§„åˆ™2å¤±è´¥çš„ä¿¡æ¯
  Content.status = "failed"       # å¿½ç•¥äº†è§„åˆ™1æˆåŠŸçš„äº‹å®
  ```
- **æ•°æ®å®Œæ•´æ€§ç¼ºå¤±**: `PushedRecord` ç¼ºå°‘ `rule_id`ï¼Œæ— æ³•è¿½æº¯æ¨é€æ¥æº

**âœ… æ”¹è¿›æ–¹æ¡ˆ**ï¼š

å¼•å…¥ `ContentQueueItem` ä¸‰å…ƒç»„æ¨¡å‹ï¼šæ¯ä¸ªé˜Ÿåˆ—é¡¹ä»£è¡¨ `(Content Ã— Rule Ã— BotChat)` ç»„åˆ

```python
class ContentQueueItem(Base):
    """ç‹¬ç«‹çš„é˜Ÿåˆ—é¡¹ï¼Œç»†ç²’åº¦çŠ¶æ€ç®¡ç†"""
    content_id = Column(Integer, ForeignKey("contents.id"))
    rule_id = Column(Integer, ForeignKey("distribution_rules.id"))
    bot_chat_id = Column(Integer, ForeignKey("bot_chats.id"))
    
    status = Column(Enum(QueueItemStatus))  # pending, scheduled, success, failed, skipped
    scheduled_at = Column(DateTime)
    
    # é¢„å¤„ç†ç¼“å­˜
    rendered_payload = Column(JSON)  # é¢„æ¸²æŸ“ç»“æœ
    nsfw_routing_result = Column(JSON)  # NSFW è·¯ç”±å†³ç­–
    passed_rate_limit = Column(Boolean)  # é¢‘ç‡é™åˆ¶æ£€æŸ¥
    
    # å®¡æ‰¹ä¸æ¨é€
    needs_approval = Column(Boolean)
    message_id = Column(String(200))
    retry_count = Column(Integer, default=0)
    error_message = Column(Text)
    
    __table_args__ = (
        UniqueConstraint("content_id", "rule_id", "bot_chat_id"),
    )
```

**ä¼˜åŠ¿å¯¹æ¯”**ï¼š

| å¯¹æ¯”ç»´åº¦ | å½“å‰æ–¹æ¡ˆ | é˜Ÿåˆ—æ¨¡å‹ |
|---------|---------|---------|
| **çŠ¶æ€ç®¡ç†** | âŒ Content çº§åˆ«ï¼ˆç²—ç²’åº¦ï¼‰ | âœ… ä¸‰å…ƒç»„çº§åˆ«ï¼ˆç»†ç²’åº¦ï¼‰ |
| **éƒ¨åˆ†å¤±è´¥å¤„ç†** | âŒ æ— æ³•è¡¨è¾¾ï¼ˆäºŒé€‰ä¸€ï¼‰ | âœ… æ¯ä¸ªæ¨é€ä»»åŠ¡ç‹¬ç«‹çŠ¶æ€ |
| **æ¨é€å†å²** | âš ï¸ PushedRecord ç¼º rule_id | âœ… å®Œæ•´å…ƒæ•°æ®ï¼ˆè§„åˆ™ã€é…ç½®ã€é‡è¯•æ¬¡æ•°ï¼‰ |
| **æ•°æ®è¿½æº¯** | âŒ éš¾ä»¥æŸ¥è¯¢"è§„åˆ™Xè§¦å‘äº†å¤šå°‘æ¬¡æ¨é€" | âœ… å®Œæ•´å…³è”å…³ç³»ï¼ŒSQL ç›´æ¥æŸ¥è¯¢ |

**å®æ–½ä¼˜å…ˆçº§**: âœ… **å·²å®Œæˆ** â€” `ContentQueueItem` æ¨¡å‹å·²å®ç°äº `app/models.py`ï¼Œé˜Ÿåˆ— API åœ¨ `app/routers/distribution_queue.py`

---

#### 2. äº‹ä»¶é©±åŠ¨å…¥é˜Ÿæœºåˆ¶

**ğŸ”´ æ ¸å¿ƒç¼ºé™·**ï¼š
- **å½“å‰é—®é¢˜**: ä¾èµ–å®šæ—¶ä»»åŠ¡ï¼ˆæ¯ 60 ç§’è½®è¯¢ï¼‰ï¼Œå»¶è¿Ÿé«˜
- **é‡å¤è®¡ç®—**: æ¯æ¬¡æ¨é€éƒ½é‡æ–°åŒ¹é…è§„åˆ™ã€æ£€æŸ¥ NSFWã€æ£€æŸ¥é¢‘ç‡é™åˆ¶
- **ç”¨æˆ·ä½“éªŒ**: å®¡æ‰¹é€šè¿‡åéœ€ç­‰å¾…æœ€é•¿ 60 ç§’æ‰æ¨é€

**âœ… æ”¹è¿›æ–¹æ¡ˆ**ï¼š

ä½¿ç”¨ SQLAlchemy äº‹ä»¶ç›‘å¬ï¼ŒContent åˆ›å»º/æ›´æ–°åç«‹å³è§¦å‘å…¥é˜Ÿï¼š

```python
@event.listens_for(Content, 'after_insert')
@event.listens_for(Content, 'after_update')
async def on_content_changed(mapper, connection, target):
    if target.status == ContentStatus.PULLED:
        background_tasks.add_task(enqueue_content, target.id)


async def enqueue_content(content_id: int):
    """
    ä¸€æ¬¡æ€§å®Œæˆæ‰€æœ‰é¢„å¤„ç†ï¼ˆé¿å…æ¨é€æ—¶é‡å¤è®¡ç®—ï¼‰:
    1. åŒ¹é…è§„åˆ™
    2. NSFW è·¯ç”±å†³ç­–
    3. é¢‘ç‡é™åˆ¶æ£€æŸ¥
    4. é¢„æ¸²æŸ“å†…å®¹
    5. è®¡ç®—æ’æœŸæ—¶é—´
    6. åˆ›å»ºé˜Ÿåˆ—é¡¹
    """
    # ... è¯¦ç»†å®ç°è§ç¬¬ä¸‰ç«  ...
```

**ä¼˜åŠ¿å¯¹æ¯”**ï¼š

| å¯¹æ¯”ç»´åº¦ | å®šæ—¶ä»»åŠ¡ | äº‹ä»¶é©±åŠ¨ |
|---------|---------|---------|
| **å“åº”å»¶è¿Ÿ** | 0-60ç§’ | å®æ—¶ï¼ˆ<1ç§’ï¼‰ |
| **é‡å¤è®¡ç®—** | âŒ æ¯æ¬¡æ¨é€éƒ½é‡ç®— | âœ… å…¥é˜Ÿæ—¶ç®—ä¸€æ¬¡ï¼Œç¼“å­˜ç»“æœ |
| **ç³»ç»Ÿè´Ÿè½½** | âš ï¸ å®šæœŸå…¨è¡¨æ‰«æ | âœ… æŒ‰éœ€è§¦å‘ |

**å®æ–½ä¼˜å…ˆçº§**: âœ… **å·²å®Œæˆ** â€” `enqueue_content()` å®ç°äº `app/distribution/queue_service.py`ï¼Œåœ¨å®¡æ‰¹/è‡ªåŠ¨å®¡æ‰¹æµç¨‹ä¸­è§¦å‘

---

#### 3. æ¨é€ Worker èŒè´£åˆ†ç¦» + é¢„æ¸²æŸ“ç¼“å­˜

**ğŸ”´ æ ¸å¿ƒç¼ºé™·**ï¼š
- **å½“å‰é—®é¢˜**: è°ƒåº¦å™¨èŒè´£æ··ä¹±ï¼ˆæ—¢åšä¸šåŠ¡åˆ¤æ–­åˆåšæ¨é€ï¼‰
- **æ€§èƒ½ç“¶é¢ˆ**: æ¯æ¬¡æ¨é€éƒ½é‡æ–°æ¸²æŸ“å†…å®¹
- **å¹¶å‘é™åˆ¶**: éš¾ä»¥æ”¯æŒå¤š worker å¹¶å‘æ¨é€

**âœ… æ”¹è¿›æ–¹æ¡ˆ**ï¼š

**èŒè´£åˆ†ç¦»**ï¼š
- **å…¥é˜Ÿé€»è¾‘**ï¼ˆä¼˜åŒ–2ï¼‰: è´Ÿè´£åŒ¹é…ã€è¿‡æ»¤ã€é¢„æ¸²æŸ“ã€æ’æœŸ
- **æ¨é€ Worker**ï¼ˆæœ¬ä¼˜åŒ–ï¼‰: åªè´Ÿè´£å‘é€ï¼Œä¸åšä¸šåŠ¡åˆ¤æ–­

**é¢„æ¸²æŸ“ç¼“å­˜**ï¼š
```python
# å…¥é˜Ÿæ—¶é¢„æ¸²æŸ“ï¼ˆåªåšä¸€æ¬¡ï¼‰
rendered = await render_content(content, rule, target, bot_chat)
queue_item.rendered_payload = rendered  # å­˜å…¥æ•°æ®åº“

# æ¨é€æ—¶ç›´æ¥ä½¿ç”¨ï¼ˆæ— éœ€é‡æ–°æ¸²æŸ“ï¼‰
message_id = await push_service.send(
    chat_id=queue_item.bot_chat.chat_id,
    payload=queue_item.rendered_payload  # ç›´æ¥ä½¿ç”¨ç¼“å­˜
)
```

**å¹¶å‘æ¨é€**ï¼š
```python
# å¯åŠ¨å¤šä¸ª worker
@app.on_event("startup")
async def startup_event():
    for i in range(3):  # 3 ä¸ªå¹¶å‘ worker
        asyncio.create_task(distribution_worker(), name=f"push-worker-{i}")
```

**ä¼˜åŠ¿å¯¹æ¯”**ï¼š

| å¯¹æ¯”ç»´åº¦ | å½“å‰æ–¹æ¡ˆ | Worker + ç¼“å­˜ |
|---------|---------|--------------|
| **èŒè´£æ¸…æ™°** | âŒ è°ƒåº¦å™¨åšæ‰€æœ‰äº‹ | âœ… å…¥é˜Ÿ/æ¨é€åˆ†ç¦» |
| **æ¸²æŸ“æ€§èƒ½** | âŒ æ¯æ¬¡æ¨é€éƒ½æ¸²æŸ“ | âœ… å…¥é˜Ÿæ—¶æ¸²æŸ“ä¸€æ¬¡ |
| **å¹¶å‘èƒ½åŠ›** | âŒ å•çº¿ç¨‹é¡ºåºæ¨é€ | âœ… å¤š worker å¹¶å‘ï¼ˆå¯æ‰©å±•ï¼‰ |
| **å¤±è´¥é‡è¯•** | âŒ æ— è‡ªåŠ¨é‡è¯• | âœ… æŒ‡æ•°é€€é¿è‡ªåŠ¨é‡è¯• |

**å®æ–½ä¼˜å…ˆçº§**: âœ… **å·²å®Œæˆ** â€” `DistributionQueueWorker` å®ç°äº `app/distribution/queue_worker.py`ï¼Œæ”¯æŒå¤š Worker å¹¶å‘ + æŒ‡æ•°é€€é¿é‡è¯•

---

### ğŸ’¡ ä¸­ä¼˜å…ˆçº§ä¼˜åŒ–ï¼ˆä¸šåŠ¡æµç¨‹æ”¹è¿›ï¼‰

#### 4. è§„åˆ™åˆ›å»ºæ—¶ä¸€é”®å…³è”ç›®æ ‡

- **å½“å‰é—®é¢˜**: éœ€è¦å…ˆåˆ›å»ºè§„åˆ™ï¼Œå†å•ç‹¬é…ç½®ç›®æ ‡ï¼ˆä¸¤æ­¥æ“ä½œï¼‰
- **ä¼˜åŒ–æ–¹æ¡ˆ**: åœ¨ `DistributionRuleDialog` ä¸­å†…åµŒç¾¤ç»„é€‰æ‹©å™¨
- **æŠ€æœ¯ç»†èŠ‚**:
  - åç«¯: `POST /distribution-rules` æ”¯æŒåµŒå¥— `targets` æ•°ç»„
  - å‰ç«¯: ä½¿ç”¨ `CheckboxListTile` å±•ç¤ºæ‰€æœ‰å¯ç”¨ç¾¤ç»„
  - æ”¯æŒæ‰¹é‡åˆ›å»º `BotChatRuleConfig` è®°å½•

**å®æ–½ä¼˜å…ˆçº§**: âœ… **å·²å®Œæˆï¼ˆ2026-02-13ï¼‰**

**å®Œæˆæƒ…å†µ**:
- åç«¯ `POST /distribution-rules` å·²æ”¯æŒåµŒå¥— `targets` æ‰¹é‡åˆ›å»ºå…³è”
- å‰ç«¯è§„åˆ™åˆ›å»ºå¼¹çª—å·²æ”¯æŒç›´æ¥å‹¾é€‰ Bot ç¾¤ç»„/é¢‘é“å¹¶ä¸€å¹¶åˆ›å»º

---

#### 5. Bot é…ç½®å¯è§†åŒ–

- **å½“å‰é—®é¢˜**: éœ€è¦ä¿®æ”¹ç¯å¢ƒå˜é‡ + é‡å¯æœåŠ¡
- **ä¼˜åŒ–æ–¹æ¡ˆ**: æ–°å»º `BotConfigPage` æ”¯æŒå¤š Bot ç®¡ç†
- **åŠŸèƒ½æ¸…å•**:
  - âœ… åœ¨çº¿æ·»åŠ /åˆ é™¤ Bot
  - âœ… Telegram: Token éªŒè¯
  - âœ… QQ: Napcat äºŒç»´ç ç™»å½•
  - âœ… åˆ‡æ¢ä¸» Bot
  - âœ… æŸ¥çœ‹æ¯ä¸ª Bot çš„ç¾¤ç»„æ•°å’Œæ¨é€ç»Ÿè®¡

**å®æ–½ä¼˜å…ˆçº§**: âœ… **å·²å®Œæˆï¼ˆ2026-02-13ï¼‰**

**å®Œæˆæƒ…å†µ**:
- å·²æ–°å¢ `BotConfig` æ¨¡å‹ä¸ `/api/v1/bot-config` ç³»åˆ— APIï¼ˆCRUD/activate/sync-chats/qr-codeï¼‰
- å·²æ–°å¢ `BotManagementPage` ä¸æ·»åŠ å‘å¯¼ï¼Œå¹¶æ¥å…¥è®¾ç½®é¡µé¢å…¥å£

---

#### 6. ç¾¤ç»„è§†è§’çš„è§„åˆ™ç®¡ç†

- **åŠŸèƒ½**: åœ¨ `BotChatCard` ä¸­æ˜¾ç¤º"åº”ç”¨çš„è§„åˆ™"æ ‡ç­¾
- **äº¤äº’**: ç‚¹å‡»è¿›å…¥è¯¦æƒ…ï¼Œå‹¾é€‰/å–æ¶ˆå‹¾é€‰è§„åˆ™
- **ç¤ºä¾‹**:
  ```
  @TechNewsChannel
  åº”ç”¨è§„åˆ™: ç§‘æŠ€æ–°é—», AIåŠ¨æ€ (+2)
  [âš™ï¸ é…ç½®è§„åˆ™]
  ```

**å®æ–½ä¼˜å…ˆçº§**: âœ… **å·²å®Œæˆï¼ˆ2026-02-13ï¼‰**

**å®Œæˆæƒ…å†µ**:
- `BotChatCard` å·²å±•ç¤ºåº”ç”¨è§„åˆ™æ‘˜è¦
- å·²æ”¯æŒæŒ‰ç¾¤ç»„æ‰¹é‡å‹¾é€‰è§„åˆ™å¹¶è¦†ç›–ä¿å­˜ï¼ˆåŒå‘ç®¡ç†ï¼‰

---

#### 7. WebSocket å®æ—¶æ›´æ–°

- **åº”ç”¨åœºæ™¯**:
  - åŒæ­¥ç¾¤ç»„æ—¶æ¨é€è¿›åº¦ï¼ˆ"å·²åŒæ­¥ 5/10 ä¸ªç¾¤ç»„..."ï¼‰
  - æ¨é€æˆåŠŸ/å¤±è´¥å®æ—¶é€šçŸ¥å‰ç«¯
  - é˜Ÿåˆ—çŠ¶æ€å˜åŒ–å®æ—¶åˆ·æ–°
- **æŠ€æœ¯é€‰å‹**: FastAPI WebSocket + Riverpod StreamProvider

**å®æ–½ä¼˜å…ˆçº§**: â³ **å¾…å®æ–½ï¼ˆç¬¬ä¸‰é˜¶æ®µï¼‰**

---

### ğŸ”§ ä½ä¼˜å…ˆçº§ä¼˜åŒ–ï¼ˆä½“éªŒæå‡ï¼‰

#### 8. æ™ºèƒ½æ’æœŸç®—æ³•

- **å½“å‰**: ç®€å•çš„æ—¶é—´çª—å£ + è®¡æ•°å™¨
- **æ”¹è¿›**: 
  - è€ƒè™‘ç›®æ ‡ç¾¤ç»„çš„æ´»è·ƒæ—¶æ®µ
  - é¿å…åŒä¸€æ—¶é—´æ¨é€è¿‡å¤šå†…å®¹
  - æ”¯æŒè‡ªå®šä¹‰æ¨é€æ—¶é—´æ®µï¼ˆä¾‹å¦‚ï¼šå·¥ä½œæ—¥ 9:00-18:00ï¼‰

**å®æ–½ä¼˜å…ˆçº§**: ğŸŸ¢ **P2 - é”¦ä¸Šæ·»èŠ±**

---

#### 9. A/B æµ‹è¯•æ”¯æŒ

- **åŠŸèƒ½**: åŒä¸€å†…å®¹ä½¿ç”¨ä¸åŒæ¸²æŸ“é…ç½®æ¨é€åˆ°ä¸åŒç¾¤ç»„
- **ç”¨é€”**: æµ‹è¯•å“ªç§æ ¼å¼çš„ç‚¹å‡»ç‡/äº’åŠ¨ç‡æ›´é«˜

**å®æ–½ä¼˜å…ˆçº§**: ğŸŸ¢ **P2 - é”¦ä¸Šæ·»èŠ±**

---

## äº”ã€å®æ–½é¡ºåºå»ºè®®

### ç¬¬ä¸€é˜¶æ®µï¼šæ¶æ„é‡æ„ï¼ˆæ ¸å¿ƒä¿®å¤ï¼‰- P0 ä¼˜å…ˆçº§ (2-3 å‘¨)

#### ğŸ”´ ç›®æ ‡ï¼šä¿®å¤æ¶æ„ç¼ºé™·ï¼Œä¸ºåç»­ä¼˜åŒ–å¥ å®šåŸºç¡€

```
âœ… 1. åˆ›å»º ContentQueueItem æ¨¡å‹ï¼ˆä¼˜åŒ–ç‚¹ 1ï¼‰
   - ç¼–å†™æ•°æ®åº“è¿ç§»è„šæœ¬
   - å®šä¹‰æ¨¡å‹ç±»å’Œç´¢å¼•
   - ç¼–å†™å•å…ƒæµ‹è¯•
   
âœ… 2. å®ç°äº‹ä»¶é©±åŠ¨å…¥é˜Ÿé€»è¾‘ï¼ˆä¼˜åŒ–ç‚¹ 2ï¼‰
   - å®ç° enqueue_content() å‡½æ•°
   - æ·»åŠ  SQLAlchemy äº‹ä»¶ç›‘å¬å™¨
   - å®ç°è§„åˆ™åŒ¹é…ã€NSFW è·¯ç”±ã€é¢‘ç‡é™åˆ¶æ£€æŸ¥
   - å®ç°é¢„æ¸²æŸ“é€»è¾‘
   
âœ… 3. å®ç°æ¨é€ Workerï¼ˆä¼˜åŒ–ç‚¹ 3ï¼‰
   - å®ç° distribution_worker() å‡½æ•°
   - æ·»åŠ å¤±è´¥é‡è¯•æœºåˆ¶ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
   - å¯åŠ¨å¤šä¸ªå¹¶å‘ worker
   - ç¼–å†™ worker ç›‘æ§æ—¥å¿—
```

#### âœ… è¿ç§»ç­–ç•¥æ‰§è¡Œç»“æœï¼ˆå·²å®Œæˆï¼‰

**é˜¶æ®µ 1.1: æ–°å»ºé˜Ÿåˆ—æ¨¡å‹ï¼ˆå·²å®Œæˆï¼‰**

```sql
-- è¿ç§»è„šæœ¬: m10_content_queue_items.sql
CREATE TABLE content_queue_items (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    content_id INTEGER NOT NULL,
    rule_id INTEGER NOT NULL,
    bot_chat_id INTEGER NOT NULL,
    status VARCHAR(20) NOT NULL DEFAULT 'pending',
    scheduled_at DATETIME,
    rendered_payload JSON,
    nsfw_routing_result JSON,
    passed_rate_limit BOOLEAN DEFAULT TRUE,
    rate_limit_reason VARCHAR(200),
    needs_approval BOOLEAN DEFAULT FALSE,
    approved_at DATETIME,
    approved_by VARCHAR(100),
    pushed_at DATETIME,
    message_id VARCHAR(200),
    error_message TEXT,
    retry_count INTEGER DEFAULT 0,
    max_retries INTEGER DEFAULT 3,
    next_retry_at DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(content_id, rule_id, bot_chat_id),
    FOREIGN KEY (content_id) REFERENCES contents(id) ON DELETE CASCADE,
    FOREIGN KEY (rule_id) REFERENCES distribution_rules(id) ON DELETE CASCADE,
    FOREIGN KEY (bot_chat_id) REFERENCES bot_chats(id) ON DELETE CASCADE
);

CREATE INDEX ix_queue_status_scheduled ON content_queue_items(status, scheduled_at);
CREATE INDEX ix_queue_content_status ON content_queue_items(content_id, status);
CREATE INDEX ix_queue_rule_status ON content_queue_items(rule_id, status);
CREATE INDEX ix_queue_chat_status ON content_queue_items(bot_chat_id, status);
```

> **âœ… å·²å®Œæˆï¼ˆ2026-02-13ï¼‰**
>
> - æ—§è°ƒåº¦ç³»ç»Ÿä¸æ—§é˜Ÿåˆ— API å·²ç§»é™¤ï¼ˆä¸å†ä¿ç•™åˆ‡æ¢å¼€å…³ï¼‰ã€‚
> - åˆ†å‘è·¯å¾„ç»Ÿä¸€ä¸º `ContentQueueItem` + `distribution/queue_worker.py`ã€‚
> - å®¡æ‰¹é€šè¿‡/è‡ªåŠ¨å®¡æ‰¹å‡ç›´æ¥è§¦å‘ `enqueue_content` å…¥é˜Ÿã€‚
> - æ–°å¢æ•°æ®åº“æ¸…ç†è„šæœ¬ï¼š`backend/migrations/m10_cleanup_legacy_distribution.sql`ï¼Œç”¨äºå°†å†å² `contents.status='distributed'` å½’ä¸€åŒ–ä¸º `pulled`ã€‚
> - æ–°å¢æ•°æ®åº“ç»“æ„æ¸…ç†è„šæœ¬ï¼š`backend/migrations/m11_drop_legacy_content_schedule_columns.sql`ï¼Œç”¨äºç§»é™¤ `contents.scheduled_at` / `contents.is_manual_schedule`ã€‚

**å½“å‰è¿è¡Œæ¨¡å¼ï¼ˆå•ä¸€æ¨¡å¼ï¼‰**

```text
å¯åŠ¨åº”ç”¨ â†’ å¯åŠ¨åˆ†å‘é˜Ÿåˆ— Worker
å®¡æ‰¹/è‡ªåŠ¨å®¡æ‰¹é€šè¿‡ â†’ enqueue_content
Worker è½®è¯¢ content_queue_items â†’ æ¨é€ â†’ å†™å…¥ pushed_records
```

**è¿ç§»æ‰§è¡Œè¯´æ˜**

```bash
cd backend
sqlite3 data/vaultstream.db < migrations/m10_cleanup_legacy_distribution.sql
sqlite3 data/vaultstream.db < migrations/m11_drop_legacy_content_schedule_columns.sql
```

---

### ç¬¬äºŒé˜¶æ®µï¼šä¸šåŠ¡æµç¨‹æ”¹è¿› - P1 ä¼˜å…ˆçº§ (2 å‘¨)

```
âœ… 4. è§„åˆ™åˆ›å»ºæ—¶ä¸€é”®å…³è”ç›®æ ‡ï¼ˆä¼˜åŒ–ç‚¹ 4ï¼‰
   - ä¿®æ”¹ DistributionRuleDialog.dart
   - æ·»åŠ  BotChatSelector ç»„ä»¶
   - åç«¯æ”¯æŒåµŒå¥— targets åˆ›å»º
   - å‰ç«¯è”è°ƒæµ‹è¯•

âœ… 5. Bot é…ç½®å¯è§†åŒ–ï¼ˆä¼˜åŒ–ç‚¹ 5ï¼‰
   - æ–°å»º BotConfig æ¨¡å‹å’Œ API
   - å®ç° CRUD ç«¯ç‚¹
   - å®ç° QR Code ç”Ÿæˆ APIï¼ˆNapcatï¼‰
   - åˆ›å»º BotManagementPage
   - å®ç° AddBotWizard
   - é›†æˆåˆ°"è®¾ç½®"é¡µé¢

âœ… 6. å®Œå–„åŒå‘ç®¡ç†ï¼ˆä¼˜åŒ–ç‚¹ 6ï¼‰
   - åœ¨ BotChatCard ä¸­æ˜¾ç¤ºåº”ç”¨çš„è§„åˆ™
   - å®ç°"ä¸ºç¾¤ç»„é€‰æ‹©è§„åˆ™"å¼¹çª—
   - æ”¯æŒå¿«æ·å¯ç”¨/ç¦ç”¨è§„åˆ™
```

> **âœ… ç¬¬äºŒé˜¶æ®µéªŒæ”¶ç»“æœï¼ˆ2026-02-13ï¼‰**
>
> - æ–°å¢/æ”¹é€  API å·²å®Œæˆå¹¶è”è°ƒé€šè¿‡ã€‚
> - æ–°å¢æµ‹è¯• `backend/tests/test_api/test_distribution_phase2.py` å·²é€šè¿‡ã€‚
> - ä¸åˆ†å‘ç›¸å…³å›å½’æµ‹è¯•é€šè¿‡ï¼ˆdistribution / distribution_targetsï¼‰ã€‚

---

### ç¬¬ä¸‰é˜¶æ®µï¼šä½“éªŒä¼˜åŒ– - P1 ä¼˜å…ˆçº§ (1-2 å‘¨)

```
âš¡ 7. WebSocket å®æ—¶é€šçŸ¥ï¼ˆä¼˜åŒ–ç‚¹ 7ï¼‰
   - è®¾è®¡æ¶ˆæ¯åè®®
   - å®ç°åç«¯æ¨é€é€»è¾‘
   - å‰ç«¯é›†æˆ StreamProvider
   - åº”ç”¨åœºæ™¯ï¼š
     â€¢ åŒæ­¥ç¾¤ç»„è¿›åº¦
     â€¢ æ¨é€æˆåŠŸ/å¤±è´¥é€šçŸ¥
     â€¢ é˜Ÿåˆ—çŠ¶æ€å®æ—¶åˆ·æ–°
```

---

### ç¬¬å››é˜¶æ®µï¼šè¿›é˜¶åŠŸèƒ½ - P2 ä¼˜å…ˆçº§ (å¯é€‰)

```
ğŸš€ 8. æ™ºèƒ½æ’æœŸç®—æ³•ï¼ˆä¼˜åŒ–ç‚¹ 8ï¼‰
   - åˆ†æç¾¤ç»„æ´»è·ƒæ—¶æ®µ
   - å®ç°æ™ºèƒ½æ’æœŸç­–ç•¥
   - æ”¯æŒè‡ªå®šä¹‰æ¨é€æ—¶é—´æ®µ

ğŸš€ 9. A/B æµ‹è¯•æ¡†æ¶ï¼ˆä¼˜åŒ–ç‚¹ 9ï¼‰
   - è®¾è®¡ A/B æµ‹è¯•æ•°æ®æ¨¡å‹
   - å®ç°æ•ˆæœè¿½è¸ª
   - æ¨é€æ•ˆæœåˆ†æé¢æ¿
```

---

### ğŸ¯ å®æ–½é‡Œç¨‹ç¢‘

| é˜¶æ®µ | æ—¶é—´ | æ ¸å¿ƒæˆæœ | éªŒæ”¶æ ‡å‡† |
|-----|------|---------|---------|
| **ç¬¬ä¸€é˜¶æ®µ** | Week 1-3 | æ¶æ„é‡æ„å®Œæˆ | âœ… é˜Ÿåˆ—æ¨¡å‹æ­£å¸¸å·¥ä½œ<br>âœ… äº‹ä»¶é©±åŠ¨å…¥é˜Ÿ<br>âœ… Worker å¹¶å‘æ¨é€<br>âœ… æ¨é€æˆåŠŸç‡ â‰¥ 99% |
| **ç¬¬äºŒé˜¶æ®µ** | Week 4-5 | ä¸šåŠ¡æµç¨‹ä¼˜åŒ– | âœ… è§„åˆ™åˆ›å»ºä¸€é”®å…³è”ç›®æ ‡<br>âœ… Bot å¯è§†åŒ–ç®¡ç†<br>âœ… ç¾¤ç»„è§„åˆ™åŒå‘ç®¡ç† |
| **ç¬¬ä¸‰é˜¶æ®µ** | Week 6-7 | ä½“éªŒä¼˜åŒ– | âœ… WebSocket å®æ—¶é€šçŸ¥<br>âœ… ç”¨æˆ·æ“ä½œå“åº” < 1s |
| **ç¬¬å››é˜¶æ®µ** | Week 8+ | è¿›é˜¶åŠŸèƒ½ | âœ… æ™ºèƒ½æ’æœŸç®—æ³•<br>âœ… A/B æµ‹è¯•æ”¯æŒ |

---

## é™„å½•ï¼šå…³é”®ä»£ç ç‰‡æ®µ

### A. è§„åˆ™åˆ›å»ºæ—¶å…³è”ç›®æ ‡ï¼ˆåç«¯ï¼‰

```python
# app/routers/distribution.py

@router.post("/distribution-rules", response_model=DistributionRuleResponse)
async def create_distribution_rule(
    rule: DistributionRuleCreate,
    db: AsyncSession = Depends(get_db),
):
    # 1. åˆ›å»ºè§„åˆ™
    db_rule = DistributionRule(**rule.model_dump(exclude={'targets'}))
    db.add(db_rule)
    await db.flush()  # è·å– rule.id
    
    # 2. æ‰¹é‡åˆ›å»ºç›®æ ‡å…³è”
    if rule.targets:
        for target_create in rule.targets:
            db_target = DistributionTarget(
                rule_id=db_rule.id,
                **target_create.model_dump()
            )
            db.add(db_target)
    
    await db.commit()
    await db.refresh(db_rule)
    return db_rule
```

### B. ç¾¤ç»„é€‰æ‹©å™¨ç»„ä»¶ï¼ˆå‰ç«¯ï¼‰

```dart
// frontend/lib/features/review/widgets/bot_chat_selector.dart

class BotChatSelector extends ConsumerWidget {
  final List<int> selectedIds;
  final ValueChanged<List<int>> onChanged;

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final chatsAsync = ref.watch(botChatsProvider);
    
    return chatsAsync.when(
      data: (chats) => Column(
        children: chats.map((chat) => CheckboxListTile(
          title: Text(chat.displayName),
          subtitle: Text(chat.chatId),
          value: selectedIds.contains(chat.id),
          onChanged: (checked) {
            final newIds = List<int>.from(selectedIds);
            checked ? newIds.add(chat.id) : newIds.remove(chat.id);
            onChanged(newIds);
          },
        )).toList(),
      ),
      loading: () => CircularProgressIndicator(),
      error: (e, _) => Text('åŠ è½½å¤±è´¥: $e'),
    );
  }
}
```

### C. äº‹ä»¶é©±åŠ¨é˜Ÿåˆ—åŒ¹é…

```python
# app/models.py

from sqlalchemy import event

@event.listens_for(Content, 'after_insert')
def on_content_created(mapper, connection, target):
    """Content åˆ›å»ºåè‡ªåŠ¨è§¦å‘è§„åˆ™åŒ¹é…"""
    if target.status == ContentStatus.PULLED:
        # ä½¿ç”¨åå°ä»»åŠ¡é¿å…é˜»å¡
        from app.distribution.engine import DistributionEngine
        background_tasks.add_task(
            DistributionEngine.match_and_queue_content,
            content_id=target.id
        )
```

---
