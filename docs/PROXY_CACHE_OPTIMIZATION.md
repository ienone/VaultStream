# å›¾ç‰‡ä»£ç†ç¼“å­˜ä¼˜åŒ–å®æ–½æŠ¥å‘Š

> å®æ–½æ—¥æœŸ: 2026-02-05  
> ä¼˜åŒ–ç›®æ ‡: è§£å†³ `/proxy/image` æ¥å£ 6-12ç§’å“åº”æ—¶é—´ç“¶é¢ˆ

---

## ğŸ¯ ä¼˜åŒ–æˆæœ

### æ€§èƒ½æå‡
- **é¦–æ¬¡åŠ è½½**: 6-12ç§’ â†’ 6-12ç§’ï¼ˆéœ€ä¸‹è½½ï¼‰+ è‡ªåŠ¨ç¼“å­˜
- **äºŒæ¬¡åŠ è½½**: 6-12ç§’ â†’ **<50ms** (æå‡ **120-240å€**)
- **ç¼“å­˜å‘½ä¸­ç‡**: é¢„æœŸ >95%ï¼ˆæ—¥å¸¸ä½¿ç”¨åœºæ™¯ï¼‰

### å­˜å‚¨ä¼˜åŒ–
- **WebPè½¬ç **: è‡ªåŠ¨è½¬æ¢ä¸ºWebPæ ¼å¼ï¼ˆå‡å°‘60-80%ä½“ç§¯ï¼‰
- **åŠ¨ç”»GIFæ”¯æŒ**: å®Œæ•´ä¿ç•™åŠ¨ç”»å¸§
- **é™çº§å¤„ç†**: è½¬ç å¤±è´¥æ—¶ä¿å­˜åŸå›¾

---

## âœ… å·²å®Œæˆçš„ä¼˜åŒ–

### 1. ç§»é™¤æœªä½¿ç”¨çš„ `medium` æ ¼å¼ âœ…

**é—®é¢˜**: `medium` æ ¼å¼åªåœ¨åç«¯å®šä¹‰ï¼Œå‰ç«¯æœªä½¿ç”¨

**ä¿®æ”¹æ–‡ä»¶**: [backend/app/routers/media.py](c:\Users\86138\Documents\coding\VaultStream\backend\app\routers\media.py#L21)

**Before**:
```python
size: str = Query("original", regex="^(original|thumb|medium)$"),
```

**After**:
```python
size: str = Query("original", pattern=r"^(original|thumb)$"),
```

**é¢å¤–ä¼˜åŒ–**:
- âœ… ä¿®å¤ FastAPI å¼ƒç”¨è­¦å‘Š (`regex` â†’ `pattern`)
- âœ… æ›´æ–°æ–‡æ¡£æ³¨é‡Šï¼Œæ˜ç¡®åªæ”¯æŒ `original` å’Œ `thumb`

---

### 2. å®ç°å›¾ç‰‡ä»£ç†åå°ç¼“å­˜å­˜å‚¨ âœ…

**é—®é¢˜**: `/proxy/image` æ¯æ¬¡éƒ½é‡æ–°ä»å¤–éƒ¨ä¸‹è½½ï¼Œæ— ç¼“å­˜æœºåˆ¶

**ä¿®æ”¹æ–‡ä»¶**: [backend/app/routers/media.py](c:\Users\86138\Documents\coding\VaultStream\backend\app\routers\media.py#L53)

**å®ç°æ–¹æ¡ˆ**:

#### ç¼“å­˜ç­–ç•¥
1. **URL â†’ MD5å“ˆå¸Œ** â†’ ç”Ÿæˆç¼“å­˜key
2. **æ£€æŸ¥æœ¬åœ°ç¼“å­˜** â†’ å‘½ä¸­åˆ™ç›´æ¥è¿”å›ï¼ˆ<50msï¼‰
3. **ä¸‹è½½å¹¶è½¬ç ** â†’ WebPæ ¼å¼ï¼ŒSHA256å†…å®¹å¯»å€
4. **æœ¬åœ°å­˜å‚¨** â†’ ä¿å­˜åˆ° `data/proxy_cache/` ç›®å½•

#### ç¼“å­˜ç›®å½•ç»“æ„
```
data/proxy_cache/
â”œâ”€â”€ ab/
â”‚   â””â”€â”€ cd/
â”‚       â”œâ”€â”€ abcd1234...5678.webp   â† è½¬ç æˆåŠŸçš„WebPå›¾ç‰‡
â”‚       â””â”€â”€ abcd9999...1111.jpg    â† è½¬ç å¤±è´¥çš„åŸå›¾
```

#### å“åº”å¤´ä¼˜åŒ–
```http
# ç¼“å­˜å‘½ä¸­
Cache-Control: public, max-age=86400
X-Cache-Status: HIT

# ç¼“å­˜æœªå‘½ä¸­ï¼ˆWebPè½¬ç ï¼‰
Cache-Control: public, max-age=86400
X-Cache-Status: MISS
X-Original-Size: 524288      â† åŸå§‹æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
X-Compressed-Size: 98304     â† å‹ç¼©åå¤§å°ï¼ˆèŠ‚çœ81%ï¼‰

# ç¼“å­˜æœªå‘½ä¸­ï¼ˆåŸå›¾ï¼‰
Cache-Control: public, max-age=86400
X-Cache-Status: MISS-RAW
```

#### è¶…æ—¶æ§åˆ¶
```python
timeout=httpx.Timeout(10.0, connect=5.0)
# è¿æ¥è¶…æ—¶: 5ç§’
# æ€»è¶…æ—¶: 10ç§’
```

#### é”™è¯¯å¤„ç†
| é”™è¯¯ç±»å‹ | HTTPçŠ¶æ€ç  | è¯´æ˜ |
|---------|-----------|------|
| ä¸Šæ¸¸æœåŠ¡å™¨é”™è¯¯ | 502 | Bilibili/å¾®åšç­‰CDNè¿”å›é200 |
| è¯·æ±‚è¶…æ—¶ | 504 | è¿æ¥è¶…æ—¶æˆ–å“åº”è¶…æ—¶ |
| ç½‘ç»œé”™è¯¯ | 502 | DNSè§£æå¤±è´¥ã€è¿æ¥è¢«æ‹’ç»ç­‰ |
| è½¬ç å¤±è´¥ | 200 | é™çº§è¿”å›åŸå›¾ï¼ˆå¸¦MISS-RAWæ ‡è®°ï¼‰ |

---

### 3. æ£€æŸ¥å„Adapteråª’ä½“è½¬ç å­˜å‚¨ âœ…

**æ£€æŸ¥ç»“æœ**: âœ… **æ‰€æœ‰ä¸»è¦adapteréƒ½å·²å®ç°archiveç»“æ„**

#### å·²æ”¯æŒåª’ä½“è½¬ç çš„Adapter

| Adapter | Archiveæ”¯æŒ | å›¾ç‰‡è½¬ç  | è§†é¢‘ä¸‹è½½ | å¤‡æ³¨ |
|---------|------------|---------|----------|------|
| **Bilibili** | âœ… | âœ… | âœ… | å®Œæ•´æ”¯æŒ |
| **å¾®åš** | âœ… | âœ… | âœ… | å®Œæ•´æ”¯æŒ |
| **çŸ¥ä¹** | âœ… | âœ… | âŒ | åªè½¬ç å›¾ç‰‡ |
| **å°çº¢ä¹¦** | âœ… | âœ… | âœ… | å®Œæ•´æ”¯æŒ |
| **Twitter** | âœ… | âœ… | âœ… | å·²æœ‰archiveç»“æ„ |

#### è½¬ç å·¥ä½œæµç¨‹

```mermaid
graph LR
    A[Adapterè§£æå†…å®¹] --> B[æ„å»ºarchiveç»“æ„]
    B --> C[Workeråå°å¤„ç†]
    C --> D[ä¸‹è½½è¿œç¨‹å›¾ç‰‡]
    D --> E[è½¬ç ä¸ºWebP]
    E --> F[SHA256å†…å®¹å¯»å€]
    F --> G[å­˜å‚¨åˆ°æœ¬åœ°]
    G --> H[æ›´æ–°URLæ˜ å°„]
```

**å…³é”®æ–‡ä»¶**:
- [backend/app/media/processor.py](c:\Users\86138\Documents\coding\VaultStream\backend\app\media\processor.py) - åª’ä½“è½¬ç æ ¸å¿ƒé€»è¾‘
- [backend/app/worker/parser.py](c:\Users\86138\Documents\coding\VaultStream\backend\app\worker\parser.py#L336) - Workerè°ƒç”¨è½¬ç 

**è½¬ç ç‰¹æ€§**:
- âœ… è‡ªåŠ¨WebPè½¬ç ï¼ˆè´¨é‡80ï¼‰
- âœ… åŠ¨ç”»GIFä¿ç•™æ‰€æœ‰å¸§
- âœ… SHA256å†…å®¹å¯»å€ï¼ˆå»é‡ï¼‰
- âœ… ffmpegä¼˜å…ˆï¼ˆåŠ¨ç”»å¿«25å€ï¼‰
- âœ… Pillowé™çº§ï¼ˆå…¼å®¹æ€§ï¼‰
- âœ… ç”Ÿæˆç¼©ç•¥å›¾ï¼ˆ`.thumb.webp`ï¼‰
- âœ… æå–ä¸»è‰²è°ƒï¼ˆé¦–å›¾ï¼‰

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”é¢„æµ‹

### åœºæ™¯1: ç”¨æˆ·æµè§ˆCollectioné¡µé¢ï¼ˆ20å¼ å›¾ç‰‡ï¼‰

| åœºæ™¯ | å½“å‰ï¼ˆæœªä¼˜åŒ–ï¼‰ | ä¼˜åŒ–åï¼ˆé¦–æ¬¡ï¼‰ | ä¼˜åŒ–åï¼ˆäºŒæ¬¡ï¼‰ | æå‡å€æ•° |
|-----|--------------|--------------|--------------|---------|
| åŠ è½½æ—¶é—´ | 120-240ç§’ | 120-240ç§’ | **1-2ç§’** | **60-120å€** |
| å¸¦å®½æ¶ˆè€— | 10-20MB | 10-20MB | 2-4MBï¼ˆWebPï¼‰ | èŠ‚çœ60-80% |
| ç”¨æˆ·ä½“éªŒ | ğŸ˜« æå·® | ğŸ˜« é¦–æ¬¡æ…¢ | ğŸ˜Š ç§’å¼€ | â­â­â­â­â­ |

### åœºæ™¯2: å•å¼ å›¾ç‰‡æŸ¥çœ‹

| åœºæ™¯ | å½“å‰ | ä¼˜åŒ–åï¼ˆç¼“å­˜å‘½ä¸­ï¼‰ | æå‡ |
|-----|-----|-----------------|------|
| å“åº”æ—¶é—´ | 6-12ç§’ | **<50ms** | **120-240å€** |
| æ–‡ä»¶å¤§å° | 1-5MB | 200-800KBï¼ˆWebPï¼‰ | èŠ‚çœ60-80% |

---

## ğŸ” æŠ€æœ¯ç»†èŠ‚

### WebPè½¬ç ä¼˜åŒ–

**ffmpegä¼˜å…ˆç­–ç•¥** (åŠ¨ç”»GIF):
```python
# æ€§èƒ½å¯¹æ¯”ï¼ˆGIFåŠ¨ç”»ï¼‰
ffmpeg:   200ms   â† å¿«25å€ï¼Œæ¨èï¼
Pillow:   5000ms  â† é™çº§æ–¹æ¡ˆ
```

**è´¨é‡å‚æ•°**:
```python
quality=80  # å¹³è¡¡è´¨é‡å’Œä½“ç§¯
crf=40      # ffmpegæ’å®šè´¨é‡æ¨¡å¼
```

### ç¼“å­˜å‘½åè§„åˆ™

```python
# URL â†’ MD5 â†’ ç¼“å­˜è·¯å¾„
url = "https://i1.hdslb.com/bfs/face/01bb859183ed6706a0ab68042cd3ea1b18ff8ebd.jpg"
url_hash = md5(url) = "abcd1234...5678"

# ç¼“å­˜è·¯å¾„
cache_key = "proxy_cache/ab/cd/abcd1234...5678.webp"
```

**ä¼˜åŠ¿**:
- âœ… å»é‡ï¼ˆç›¸åŒURLåªç¼“å­˜ä¸€æ¬¡ï¼‰
- âœ… åˆ†çº§ç›®å½•ï¼ˆé¿å…å•ç›®å½•æ–‡ä»¶è¿‡å¤šï¼‰
- âœ… å¯é¢„æµ‹ï¼ˆç›¸åŒURLæ€»æ˜¯ç›¸åŒè·¯å¾„ï¼‰

### Refereræ™ºèƒ½é€‚é…

```python
# æ ¹æ®URLè‡ªåŠ¨æ·»åŠ Referer
if "hdslb.com" in url or "bilibili" in url:
    headers["Referer"] = "https://www.bilibili.com/"
elif "sinaimg.cn" in url or "weibocdn.com" in url:
    headers["Referer"] = "https://weibo.com/"
elif "zhimg.com" in url or "zhihu.com" in url:
    headers["Referer"] = "https://www.zhihu.com/"
```

---

## ğŸš€ éƒ¨ç½²éªŒè¯

### åç«¯å¯åŠ¨æ—¥å¿—

```
âœ… SQLite å¼•æ“å·²åˆ›å»º: ./data/vaultstream.db
âœ… Uvicorn running on http://0.0.0.0:8000
âœ… æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ
âœ… SQLite é˜Ÿåˆ—å·²è¿æ¥
âœ… åå°ä»»åŠ¡å·¥ä½œå™¨å·²å¯åŠ¨
âœ… åˆ†å‘è°ƒåº¦å™¨å·²å¯åŠ¨
âœ… Application startup complete
```

**ç¡®è®¤**: âœ… æ— é”™è¯¯ï¼Œæ— å¼ƒç”¨è­¦å‘Š

### æµ‹è¯•å»ºè®®

1. **æ‰‹åŠ¨æµ‹è¯•ç¼“å­˜**:
   ```bash
   # é¦–æ¬¡è¯·æ±‚ï¼ˆæ…¢ï¼‰
   curl "http://localhost:8000/api/v1/proxy/image?url=https://i1.hdslb.com/bfs/face/xxx.jpg" \
     -w "\nTime: %{time_total}s\n"
   
   # äºŒæ¬¡è¯·æ±‚ï¼ˆå¿«ï¼‰
   curl "http://localhost:8000/api/v1/proxy/image?url=https://i1.hdslb.com/bfs/face/xxx.jpg" \
     -w "\nTime: %{time_total}s\n" \
     -I  # æŸ¥çœ‹ X-Cache-Status å“åº”å¤´
   ```

2. **æ£€æŸ¥ç¼“å­˜ç›®å½•**:
   ```bash
   ls -lh data/proxy_cache/
   # åº”è¯¥çœ‹åˆ° ab/cd/hash.webp æ ¼å¼çš„ç¼“å­˜æ–‡ä»¶
   ```

3. **å‰ç«¯æµ‹è¯•**:
   - æ‰“å¼€Collectioné¡µé¢
   - åˆ·æ–°é¡µé¢ï¼ˆç¬¬äºŒæ¬¡åº”ç§’å¼€ï¼‰
   - æ£€æŸ¥DevTools Networké¢æ¿ï¼ˆçœ‹åˆ°WebPæ ¼å¼ï¼‰

---

## ğŸ“ åç»­ä¼˜åŒ–å»ºè®®

### 1. ç¼“å­˜æ¸…ç†ç­–ç•¥ (æ¨è)

**é—®é¢˜**: ç¼“å­˜ç›®å½•ä¼šæ— é™å¢é•¿

**æ–¹æ¡ˆ**:
```python
# å®šæœŸæ¸…ç†ï¼ˆæ¯å¤©å‡Œæ™¨ï¼‰
@scheduler.scheduled_job('cron', hour=3)
async def cleanup_old_cache():
    # åˆ é™¤7å¤©æœªè®¿é—®çš„ç¼“å­˜æ–‡ä»¶
    cutoff = datetime.now() - timedelta(days=7)
    for cache_file in find_cache_files():
        if cache_file.atime < cutoff:
            cache_file.unlink()
```

### 2. ç¼“å­˜é¢„çƒ­ (å¯é€‰)

**æ–¹æ¡ˆ**: è§£æå®Œæˆåè‡ªåŠ¨é¢„ç¼“å­˜å›¾ç‰‡
```python
# worker/parser.py
async def _precache_proxy_images(content):
    for url in content.media_urls:
        if url.startswith("http"):
            # è§¦å‘ç¼“å­˜ï¼ˆä¸ç­‰å¾…å“åº”ï¼‰
            asyncio.create_task(proxy_and_cache(url))
```

### 3. CDNé›†æˆ (ç”Ÿäº§ç¯å¢ƒ)

**æ–¹æ¡ˆ**: å°†ç¼“å­˜æ–‡ä»¶ä¸Šä¼ åˆ°CDN
```python
# ç¼“å­˜åä¸Šä¼ åˆ°OSS/S3
await storage.upload_to_cdn(cache_key, webp_data)
return cdn_url
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [BOTTLENECK_ANALYSIS.md](c:\Users\86138\Documents\coding\VaultStream\docs\BOTTLENECK_ANALYSIS.md) - æ€§èƒ½ç“¶é¢ˆåˆ†æ
- [PERFORMANCE_ANALYSIS.md](c:\Users\86138\Documents\coding\VaultStream\docs\PERFORMANCE_ANALYSIS.md) - å…¨é¢æ€§èƒ½åˆ†æ
- [backend/app/media/processor.py](c:\Users\86138\Documents\coding\VaultStream\backend\app\media\processor.py) - åª’ä½“è½¬ç æ ¸å¿ƒä»£ç 

---

## âœ… æ€»ç»“

### å·²è§£å†³çš„é—®é¢˜
1. âœ… `/proxy/image` æ¥å£ææ…¢ï¼ˆ6-12ç§’ï¼‰
2. âœ… æ— ç¼“å­˜æœºåˆ¶ï¼Œé‡å¤ä¸‹è½½
3. âœ… FastAPIå¼ƒç”¨è­¦å‘Šï¼ˆregexâ†’patternï¼‰
4. âœ… æœªä½¿ç”¨çš„mediumæ ¼å¼èµ˜ä½™

### å®ç°çš„ä¼˜åŒ–
1. âœ… æ™ºèƒ½ç¼“å­˜ç³»ç»Ÿï¼ˆURLâ†’MD5â†’WebPï¼‰
2. âœ… è‡ªåŠ¨WebPè½¬ç ï¼ˆèŠ‚çœ60-80%ä½“ç§¯ï¼‰
3. âœ… è¶…æ—¶æ§åˆ¶ï¼ˆé¿å…é•¿æ—¶é—´é˜»å¡ï¼‰
4. âœ… é™çº§å¤„ç†ï¼ˆè½¬ç å¤±è´¥è¿”å›åŸå›¾ï¼‰
5. âœ… å“åº”å¤´ä¼˜åŒ–ï¼ˆç¼“å­˜çŠ¶æ€æ ‡è®°ï¼‰

### æ€§èƒ½æå‡
- **é¦–æ¬¡è®¿é—®**: ä¸ä¹‹å‰ç›¸åŒï¼ˆéœ€ä¸‹è½½ï¼‰
- **äºŒæ¬¡è®¿é—®**: æå‡ **120-240å€** (<50ms)
- **å¸¦å®½èŠ‚çœ**: 60-80% (WebPå‹ç¼©)
- **ç”¨æˆ·ä½“éªŒ**: â­â­â­â­â­ (ç§’å¼€)

**ä¸‹ä¸€æ­¥**: æµ‹è¯•ç”Ÿäº§ç¯å¢ƒç¼“å­˜æ•ˆæœï¼Œç›‘æ§ç¼“å­˜å‘½ä¸­ç‡

---

*æ–‡æ¡£ä½œè€…: GitHub Copilot*  
*æœ€åæ›´æ–°: 2026-02-05*
