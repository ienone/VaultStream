# VaultStream æ¶æ„è®¾è®¡æ–‡æ¡£

> **ğŸ“Œ é‡è¦è¯´æ˜**: æœ¬æ–‡æ¡£æè¿°çš„æ˜¯åŸå§‹çš„ç”Ÿäº§çº§æ¶æ„è®¾è®¡ã€‚**å½“å‰å®ç°å·²è¿ç§»è‡³è½»é‡åŒ–æ¶æ„**ï¼ˆSQLite + æœ¬åœ°å­˜å‚¨ + ä»»åŠ¡è¡¨é˜Ÿåˆ—ï¼‰ã€‚
> 
> æ–‡æ¡£ä¸­æåˆ°çš„PostgreSQL/Redis/MinIOå·²è¢«ç§»é™¤ï¼Œä½†ä»£ç ä¿ç•™äº†é€‚é…å™¨æŠ½è±¡å±‚ä»¥ä¾¿æœªæ¥æ‰©å±•ã€‚
> 
> **å½“å‰æ¶æ„æ–‡æ¡£**: [è½»é‡åŒ–éƒ¨ç½²æŒ‡å—](LIGHTWEIGHT_DEPLOYMENT.md)
>
> ä»¥ä¸‹å†…å®¹ä½œä¸ºè®¾è®¡å‚è€ƒä¿ç•™ã€‚

## 1. ç³»ç»Ÿæ¦‚è§ˆ

VaultStream æ˜¯ä¸€ä¸ªå¤šå¹³å°å†…å®¹èšåˆå’Œå½’æ¡£ç³»ç»Ÿï¼Œæ”¯æŒä» B ç«™ç­‰å¹³å°æŠ“å–å†…å®¹ï¼Œå­˜å‚¨åˆ°ç§æœ‰å½’æ¡£ï¼Œå¹¶å¯æ¨é€åˆ° Telegram ç­‰ç›®æ ‡å¹³å°ã€‚

### æ ¸å¿ƒç‰¹æ€§ï¼ˆå½“å‰å®ç°ï¼‰

- ğŸ¯ å¤šå¹³å°æ”¯æŒï¼šå½“å‰æ”¯æŒ B ç«™ï¼ˆè§†é¢‘/åŠ¨æ€/ä¸“æ ï¼‰ã€Twitter/Xã€å¾®åšã€çŸ¥ä¹ã€å°çº¢ä¹¦ï¼Œå¯æ‰©å±•å…¶ä»–å¹³å°
- ğŸ“¦ ç§æœ‰å½’æ¡£ï¼šå®Œæ•´ä¿å­˜å†…å®¹å…ƒæ•°æ®å’Œåª’ä½“èµ„æºï¼ˆSQLiteå­˜å‚¨ï¼‰
- ğŸ–¼ï¸ åª’ä½“å¤„ç†ï¼šè‡ªåŠ¨ä¸‹è½½å›¾ç‰‡å¹¶è½¬ç ä¸º WebP æ ¼å¼ä¼˜åŒ–å­˜å‚¨
- ğŸ”„ å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—ï¼šåŸºäº SQLite Taskè¡¨çš„ä»»åŠ¡é˜Ÿåˆ—ç³»ç»Ÿ
- ğŸ¤– Bot é›†æˆï¼šTelegram Bot æ¨é€åˆ°é¢‘é“
- ğŸ’¾ æœ¬åœ°å­˜å‚¨ï¼šSHA256å†…å®¹å¯»å€ + 2çº§ç›®å½•åˆ†ç‰‡

---

## 2. æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           VaultStream ç³»ç»Ÿ                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·/å®¢æˆ·ç«¯     â”‚         â”‚   Telegram Bot   â”‚         â”‚   å¤–éƒ¨å¹³å° API    â”‚
â”‚                  â”‚         â”‚                  â”‚         â”‚  (Bilibili etc)  â”‚
â”‚  - Web ç•Œé¢      â”‚         â”‚  - æ¥æ”¶å‘½ä»¤      â”‚         â”‚                  â”‚
â”‚  - API è°ƒç”¨      â”‚         â”‚  - æ¨é€åˆ°é¢‘é“    â”‚         â”‚  - è·å–å†…å®¹      â”‚
â”‚  - ç›´æ¥URLåˆ†äº«   â”‚         â”‚                  â”‚         â”‚  - ä¸‹è½½åª’ä½“      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                            â”‚                            â”‚
         â”‚ HTTP API                   â”‚ HTTP API                   â”‚ HTTP/HTTPS
         â–¼                            â–¼                            â–²
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         FastAPI åº”ç”¨å±‚                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  API Routes (app/api.py)                                     â”‚  â”‚
â”‚  â”‚  - POST /api/v1/shares         åˆ›å»ºåˆ†äº«                       â”‚  â”‚
â”‚  â”‚  - GET  /api/v1/contents       æŸ¥è¯¢å†…å®¹                       â”‚  â”‚
â”‚  â”‚  - POST /api/v1/bot/get-content  Botè·å–å†…å®¹                  â”‚  â”‚
â”‚  â”‚  - POST /api/v1/bot/mark-pushed  æ ‡è®°å·²æ¨é€                   â”‚  â”‚
â”‚  â”‚  - GET  /api/v1/health         å¥åº·æ£€æŸ¥                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Middleware                                                   â”‚  â”‚
â”‚  â”‚  - Request ID è¿½è¸ª                                            â”‚  â”‚
â”‚  â”‚  - CORS è·¨åŸŸ                                                  â”‚  â”‚
â”‚  â”‚  - API Token é‰´æƒ                                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                       â”‚
            â”‚                       â”‚
            â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä»»åŠ¡é˜Ÿåˆ—å±‚           â”‚   â”‚   é€‚é…å™¨å±‚                â”‚
â”‚   (app/queue.py)      â”‚   â”‚   (app/adapters/)        â”‚
â”‚                       â”‚   â”‚                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  TaskQueue      â”‚  â”‚   â”‚  â”‚  AdapterFactory    â”‚  â”‚
â”‚  â”‚  - enqueue()    â”‚  â”‚   â”‚  â”‚  - detect_platform â”‚  â”‚
â”‚  â”‚  - dequeue()    â”‚  â”‚   â”‚  â”‚  - create()        â”‚  â”‚
â”‚  â”‚  - mark_done()  â”‚  â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚           â”‚              â”‚
â”‚           â”‚           â”‚   â”‚           â–¼              â”‚
â”‚           â”‚ Redis     â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚           â”‚ LPUSH/    â”‚   â”‚  â”‚  BilibiliAdapter   â”‚  â”‚
â”‚           â”‚ BRPOP     â”‚   â”‚  â”‚  - parse()         â”‚  â”‚
â”‚           â–¼           â”‚   â”‚  â”‚  - clean_url()     â”‚  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚  â”‚  - fetch_opus()    â”‚  â”‚
â”‚  â”‚  Redis          â”‚  â”‚   â”‚  â”‚  - fetch_video()   â”‚  â”‚
â”‚  â”‚  - tasks queue  â”‚  â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”‚  - dead letters â”‚  â”‚   â”‚                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚  (å¯æ‰©å±•å…¶ä»–å¹³å°é€‚é…å™¨)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
            â”‚                            â”‚
            â–¼                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    åå°ä»»åŠ¡å¤„ç†å™¨        â”‚   â”‚   åª’ä½“å¤„ç†å±‚              â”‚
â”‚   (app/worker.py)     â”‚   â”‚   (app/media_processing) â”‚
â”‚                       â”‚   â”‚                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  TaskWorker     â”‚  â”‚   â”‚  â”‚   å›¾ç‰‡ä¸‹è½½å’Œè½¬ç      â”‚  â”‚
â”‚  â”‚  - start()      â”‚  â”‚   â”‚  â”‚  - download_image  â”‚  â”‚
â”‚  â”‚  - process()    â”‚  â”‚   â”‚  â”‚  - to_webp()       â”‚  â”‚
â”‚  â”‚  - retry logic  â”‚  â”‚   â”‚  â”‚  - content hash    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â”‚           â”‚   â”‚                          â”‚
â”‚           â”‚  è½®è¯¢ä»»åŠ¡   â”‚   â”‚  (æœªæ¥: éŸ³è§†é¢‘è½¬ç )       â”‚
â”‚           â–¼           â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  æŒç»­ä»é˜Ÿåˆ—è·å–ä»»åŠ¡    â”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
            â”‚                            â”‚
            â–¼                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          æ•°æ®æŒä¹…å±‚                                   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  PostgreSQL æ•°æ®åº“      â”‚         â”‚  å¯¹è±¡å­˜å‚¨åç«¯                â”‚  â”‚
â”‚  â”‚  (app/database.py)     â”‚         â”‚  (app/storage.py)          â”‚  â”‚
â”‚  â”‚                        â”‚         â”‚                            â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  Contents è¡¨     â”‚  â”‚         â”‚  â”‚  LocalStorage        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - id            â”‚  â”‚         â”‚  â”‚  - æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - platform      â”‚  â”‚         â”‚  â”‚  - data/storage/     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - url           â”‚  â”‚         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚  â”‚  - status        â”‚  â”‚         â”‚           æˆ–               â”‚  â”‚
â”‚  â”‚  â”‚  - title         â”‚  â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  - metadata      â”‚  â”‚         â”‚  â”‚  S3Storage (MinIO)   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - cover_url     â”‚  â”‚         â”‚  â”‚  - endpoint          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - media_urls    â”‚  â”‚         â”‚  â”‚  - bucket            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - raw_metadata  â”‚  â”‚         â”‚  â”‚  - presigned URLs    â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                        â”‚         â”‚                            â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚         â”‚  å­˜å‚¨ç»“æ„ (å†…å®¹å¯»å€):         â”‚  â”‚
â”‚  â”‚  â”‚  ContentSources  â”‚  â”‚         â”‚  blobs/sha256/XX/YY/       â”‚  â”‚
â”‚  â”‚  â”‚  - source info   â”‚  â”‚         â”‚    {sha256}.webp           â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚         â”‚                            â”‚  â”‚
â”‚  â”‚                        â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                                         â”‚
â”‚  â”‚  â”‚  PushedRecords   â”‚  â”‚                                         â”‚
â”‚  â”‚  â”‚  - push history  â”‚  â”‚                                         â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 3.1 FastAPI åº”ç”¨å±‚ (`app/main.py`, `app/api.py`)

èŒè´£ï¼š
- HTTP API å…¥å£
- è¯·æ±‚è·¯ç”±å’Œå‚æ•°éªŒè¯
- ä¸­é—´ä»¶å¤„ç†ï¼ˆæ—¥å¿—ã€é‰´æƒã€CORSï¼‰

ä¸»è¦ç«¯ç‚¹ï¼š

| ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½ | å¤‡æ³¨ |
|------|------|------|------|
| `/api/v1/shares` | POST | åˆ›å»ºå†…å®¹åˆ†äº« | æ¥æ”¶URLï¼Œè¯†åˆ«å¹³å°ï¼Œå…¥åº“å¹¶å…¥é˜Ÿ |
| `/api/v1/contents` | GET | æŸ¥è¯¢å†…å®¹åˆ—è¡¨ | æ”¯æŒè¿‡æ»¤ã€åˆ†é¡µ |
| `/api/v1/contents/{id}` | GET | è·å–å†…å®¹è¯¦æƒ… | åŒ…å«å®Œæ•´å…ƒæ•°æ® |
| `/api/v1/bot/get-content` | POST | Bot è·å–å¾…æ¨é€å†…å®¹ | è¿”å›æœªæ¨é€çš„å†…å®¹ |
| `/api/v1/bot/mark-pushed` | POST | æ ‡è®°å†…å®¹å·²æ¨é€ | è®°å½•æ¨é€å†å² |
| `/api/v1/health` | GET | å¥åº·æ£€æŸ¥ | è¿”å›ç³»ç»ŸçŠ¶æ€ |

### 3.2 é€‚é…å™¨å±‚ (`app/adapters/`)

è®¾è®¡æ¨¡å¼ï¼šå·¥å‚æ¨¡å¼ + ç­–ç•¥æ¨¡å¼

```python
AdapterFactory
â”œâ”€â”€ detect_platform(url) â†’ Platform
â”œâ”€â”€ create(platform) â†’ BaseAdapter
â”‚
BaseAdapter (æŠ½è±¡åŸºç±»)
â”œâ”€â”€ parse(url) â†’ ParsedContent
â”œâ”€â”€ clean_url(url) â†’ str
â”‚
BilibiliAdapter (å…·ä½“å®ç°)
â”œâ”€â”€ parse(url)
â”‚   â”œâ”€â”€ è¯†åˆ«å†…å®¹ç±»å‹ (opus/video/article)
â”‚   â”œâ”€â”€ è°ƒç”¨å¯¹åº”è§£æå™¨
â”‚   â””â”€â”€ è¿”å›ç»Ÿä¸€ç»“æ„
â”œâ”€â”€ fetch_opus()
â”œâ”€â”€ fetch_video()
â””â”€â”€ fetch_article()
```

æ‰©å±•æ€§ï¼š
- æ–°å¢å¹³å°åªéœ€ç»§æ‰¿ `BaseAdapter`
- å®ç° `parse()` å’Œ `clean_url()` æ–¹æ³•
- åœ¨ `AdapterFactory` æ³¨å†Œ

### 3.3 ä»»åŠ¡é˜Ÿåˆ— (`app/queue.py`)

å®ç°ï¼šåŸºäº Redis List çš„ç®€å•é˜Ÿåˆ—

```python
TaskQueue
â”œâ”€â”€ enqueue(task_data)        # LPUSH åˆ°é˜Ÿåˆ—
â”œâ”€â”€ dequeue(timeout)           # BRPOP é˜»å¡è·å–
â”œâ”€â”€ mark_complete(content_id)  # ä» processing é›†åˆç§»é™¤
â””â”€â”€ push_dead_letter(task)     # å¤±è´¥ä»»åŠ¡å½’æ¡£
```

ä»»åŠ¡ç»“æ„ï¼š
```json
{
  "schema_version": 1,
  "action": "parse",
  "content_id": 123,
  "task_id": "uuid",
  "attempt": 0,
  "max_attempts": 3
}
```

### 3.4 åå° Worker (`app/worker.py`)

æ ¸å¿ƒæµç¨‹ï¼š

```python
TaskWorker.start()
  â””â”€> while running:
        â”œâ”€> task = queue.dequeue(timeout=5)
        â”œâ”€> if task:
        â”‚     â””â”€> process_task(task)
        â”‚           â”œâ”€> è·å– Content è®°å½•
        â”‚           â”œâ”€> æ›´æ–°çŠ¶æ€ä¸º PROCESSING
        â”‚           â”œâ”€> è°ƒç”¨ Adapter.parse()
        â”‚           â”œâ”€> å¦‚æœå¯ç”¨åª’ä½“å¤„ç†:
        â”‚           â”‚     â””â”€> å¤„ç†å½’æ¡£å›¾ç‰‡
        â”‚           â”œâ”€> æ›´æ–° Content ä¿¡æ¯
        â”‚           â”œâ”€> çŠ¶æ€æ”¹ä¸º PULLED
        â”‚           â””â”€> mark_complete()
        â””â”€> å¼‚å¸¸å¤„ç†ï¼š
              â”œâ”€> è®°å½•å¤±è´¥ä¿¡æ¯
              â”œâ”€> é‡è¯•é€»è¾‘ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
              â””â”€> è¾¾åˆ°æœ€å¤§æ¬¡æ•° â†’ dead letter
```

é‡è¯•ç­–ç•¥ï¼š
- å¯é‡è¯•é”™è¯¯ï¼šç½‘ç»œè¶…æ—¶ã€ä¸´æ—¶æ•…éšœ
- ä¸å¯é‡è¯•é”™è¯¯ï¼šæƒé™ä¸è¶³ã€å†…å®¹ä¸å­˜åœ¨
- æŒ‡æ•°é€€é¿ï¼š1s â†’ 2s â†’ 4s â†’ 8s...

### 3.5 åª’ä½“å¤„ç† (`app/media_processing.py`)

å½“å‰å®ç°ï¼šå½’æ¡£å›¾ç‰‡å¤„ç†

```python
store_archive_images_as_webp()
  â”œâ”€> éå† archive.images
  â”œâ”€> å¯¹æ¯å¼ å›¾ç‰‡:
  â”‚     â”œâ”€> ä¸‹è½½åŸå›¾ (httpx)
  â”‚     â”œâ”€> è½¬ç ä¸º WebP (Pillow)
  â”‚     â”œâ”€> è®¡ç®— SHA256
  â”‚     â”œâ”€> ç”Ÿæˆå†…å®¹å¯»å€ key
  â”‚     â”œâ”€> ä¸Šä¼ åˆ°å­˜å‚¨åç«¯
  â”‚     â””â”€> æ›´æ–° metadata (stored_key, stored_url)
  â””â”€> è¿”å›æ›´æ–°åçš„ archive
```

å†…å®¹å¯»å€ï¼š
```
key = blobs/sha256/AB/CD/ABCD1234...WXYZ.webp
      â†‘       â†‘    â†‘  â†‘   â†‘
      |       |    |  |   å®Œæ•´ SHA256
      |       |    |  SHA256[2:4]
      |       |    SHA256[:2]
      |       å“ˆå¸Œç®—æ³•
      blob ç±»å‹
```

ä¼˜ç‚¹ï¼š
- å»é‡ï¼šç›¸åŒå†…å®¹åªå­˜å‚¨ä¸€æ¬¡
- å¯éªŒè¯ï¼šå¯é€šè¿‡ SHA256 æ ¡éªŒå®Œæ•´æ€§
- åˆ†å¸ƒå‡åŒ€ï¼šå‰ç¼€åˆ†æ¡¶é¿å…å•ç›®å½•æ–‡ä»¶è¿‡å¤š

### 3.6 å­˜å‚¨åç«¯ (`app/storage.py`)

æŠ½è±¡æ¥å£ï¼š

```python
StorageBackend (æŠ½è±¡åŸºç±»)
â”œâ”€â”€ put_bytes(key, data, content_type) â†’ StoredObject
â”œâ”€â”€ exists(key) â†’ bool
â””â”€â”€ get_url(key) â†’ Optional[str]
```

ä¸¤ç§å®ç°ï¼š

#### LocalStorageBackend
- å­˜å‚¨ä½ç½®ï¼š`data/storage/` (å¯é…ç½®)
- URL ç”Ÿæˆï¼š`{public_base_url}/{key}`
- é€‚ç”¨åœºæ™¯ï¼šå¼€å‘ç¯å¢ƒã€å°è§„æ¨¡éƒ¨ç½²

#### S3StorageBackend (MinIO å…¼å®¹)
- å®¢æˆ·ç«¯ï¼šboto3
- å¯»å€æ–¹å¼ï¼šPath-style (å…¼å®¹ MinIO)
- URL ç”Ÿæˆï¼š
  - å…¬å¼€æ¡¶ï¼š`{public_base_url}/{bucket}/{key}`
  - ç§æœ‰æ¡¶ï¼šé¢„ç­¾å URL (presigned)
- é€‚ç”¨åœºæ™¯ï¼šç”Ÿäº§ç¯å¢ƒã€å¤§è§„æ¨¡éƒ¨ç½²

MinIO é›†æˆè¦ç‚¹ï¼š
```python
# è‡ªåŠ¨åˆ›å»º bucket
await storage.ensure_bucket()

# é¢„ç­¾å URL (ç§æœ‰æ¡¶è®¿é—®)
storage_s3_presign_urls = True
storage_s3_presign_expires = 3600  # 1å°æ—¶æœ‰æ•ˆæœŸ
```

### 3.7 æ•°æ®åº“æ¨¡å‹ (`app/models.py`)

æ ¸å¿ƒè¡¨ç»“æ„ï¼š

```sql
-- å†…å®¹è¡¨
CREATE TABLE contents (
    id SERIAL PRIMARY KEY,
    platform VARCHAR NOT NULL,           -- BILIBILI, YOUTUBE, etc
    url VARCHAR NOT NULL,                -- åŸå§‹ URL
    canonical_url VARCHAR NOT NULL,      -- è§„èŒƒåŒ– URL (å»é‡ç”¨)
    clean_url VARCHAR,                   -- æ¸…ç†å URL (å±•ç¤ºç”¨)
    status VARCHAR NOT NULL,             -- UNPROCESSED, PROCESSING, PULLED, FAILED
    
    -- å…ƒæ•°æ®
    title VARCHAR,
    description TEXT,
    author_name VARCHAR,
    author_id VARCHAR,
    platform_id VARCHAR,                 -- å¹³å°å†…å®¹ ID (BVå·ç­‰)
    content_type VARCHAR,                -- opus, video, article
    
    -- åª’ä½“èµ„æº (å¯¹å¤–åˆ†äº«)
    cover_url VARCHAR,                   -- å°é¢å›¾ URL
    media_urls JSON,                     -- åª’ä½“ URL åˆ—è¡¨
    
    -- ç§æœ‰å½’æ¡£
    raw_metadata JSON,                   -- å®Œæ•´å…ƒæ•°æ® (å« archive)
    
    -- ç»Ÿè®¡æ•°æ®
    view_count INTEGER,
    like_count INTEGER,
    collect_count INTEGER,
    share_count INTEGER,
    comment_count INTEGER,
    extra_stats JSON,                    -- å¹³å°ç‰¹æœ‰ç»Ÿè®¡
    
    -- åˆ†ç±»å’Œæ¥æº
    tags JSON,                           -- æ ‡ç­¾åˆ—è¡¨
    source VARCHAR,                      -- æ¥æºæ ‡è¯†
    is_nsfw BOOLEAN,
    
    -- é”™è¯¯å¤„ç†
    failure_count INTEGER DEFAULT 0,
    last_error TEXT,
    last_error_type VARCHAR,
    last_error_detail JSON,
    last_error_at TIMESTAMP,
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    published_at TIMESTAMP,              -- å†…å®¹å‘å¸ƒæ—¶é—´
    
    UNIQUE(platform, canonical_url)      -- ç»„åˆå”¯ä¸€çº¦æŸ
);

-- å†…å®¹æ¥æºè¡¨
CREATE TABLE content_sources (
    id SERIAL PRIMARY KEY,
    content_id INTEGER REFERENCES contents(id),
    source VARCHAR,                      -- æ¥æºæ¸ é“
    tags_snapshot JSON,                  -- åˆ›å»ºæ—¶çš„æ ‡ç­¾
    note TEXT,                           -- å¤‡æ³¨
    client_context JSON,                 -- å®¢æˆ·ç«¯ä¸Šä¸‹æ–‡
    created_at TIMESTAMP DEFAULT NOW()
);

-- æ¨é€è®°å½•è¡¨
CREATE TABLE pushed_records (
    id SERIAL PRIMARY KEY,
    content_id INTEGER REFERENCES contents(id),
    target_platform VARCHAR NOT NULL,    -- TG_CHANNEL_xxx
    pushed_at TIMESTAMP DEFAULT NOW(),
    push_context JSON                    -- æ¨é€ä¸Šä¸‹æ–‡
);
```

---

## 4. æ•°æ®æµå’Œå·¥ä½œæµç¨‹

### 4.1 å†…å®¹åˆ›å»ºæµç¨‹

```
ç”¨æˆ·æäº¤ URL
   â”‚
   â”œâ”€> POST /api/v1/shares
   â”‚
   â”œâ”€> [API] é¢„å¤„ç† URL
   â”‚     â”œâ”€> normalize_bilibili_url() (æ”¯æŒ BV/av/cv)
   â”‚     â””â”€> canonicalize_url()
   â”‚
   â”œâ”€> [API] æ£€æµ‹å¹³å°
   â”‚     â””â”€> AdapterFactory.detect_platform()
   â”‚
   â”œâ”€> [API] è®¡ç®— canonical_url (å»é‡)
   â”‚     â””â”€> adapter.clean_url()
   â”‚
   â”œâ”€> [DB] æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
   â”‚     â””â”€> SELECT WHERE platform + canonical_url
   â”‚
   â”œâ”€> å¦‚æœä¸å­˜åœ¨:
   â”‚     â”œâ”€> åˆ›å»º Content è®°å½• (status=UNPROCESSED)
   â”‚     â”œâ”€> åˆ›å»º ContentSource è®°å½•
   â”‚     â”œâ”€> æäº¤è§£æä»»åŠ¡åˆ°é˜Ÿåˆ—
   â”‚     â”‚     â””â”€> task_queue.enqueue({content_id, action: "parse"})
   â”‚     â””â”€> è¿”å› content_id
   â”‚
   â””â”€> å¦‚æœå·²å­˜åœ¨:
         â”œâ”€> ä»åˆ›å»º ContentSource (è®°å½•æ¥æº)
         â””â”€> è¿”å›å·²æœ‰ content_id
```

### 4.2 å†…å®¹è§£ææµç¨‹ (Worker)

```
Worker è½®è¯¢é˜Ÿåˆ—
   â”‚
   â”œâ”€> task = queue.dequeue(timeout=5)
   â”‚
   â”œâ”€> è·å– Content è®°å½•
   â”‚     â””â”€> SELECT FROM contents WHERE id = task.content_id
   â”‚
   â”œâ”€> æ›´æ–°çŠ¶æ€ â†’ PROCESSING
   â”‚
   â”œâ”€> è°ƒç”¨é€‚é…å™¨è§£æ
   â”‚     â”œâ”€> adapter = AdapterFactory.create(platform, cookies)
   â”‚     â”œâ”€> parsed = adapter.parse(url)
   â”‚     â”‚     â”‚
   â”‚     â”‚     â”œâ”€> [Bilibili] è¯†åˆ«ç±»å‹
   â”‚     â”‚     â”‚     â”œâ”€> opus â†’ fetch_opus()
   â”‚     â”‚     â”‚     â”œâ”€> video â†’ fetch_video()
   â”‚     â”‚     â”‚     â””â”€> article â†’ fetch_article()
   â”‚     â”‚     â”‚
   â”‚     â”‚     â”œâ”€> è°ƒç”¨å¹³å° API
   â”‚     â”‚     â”‚     â””â”€> httpx.get(api_url, cookies, headers)
   â”‚     â”‚     â”‚
   â”‚     â”‚     â””â”€> è¿”å› ParsedContent
   â”‚     â”‚           â”œâ”€> clean_url
   â”‚     â”‚           â”œâ”€> content_type
   â”‚     â”‚           â”œâ”€> title, description
   â”‚     â”‚           â”œâ”€> author_name, author_id
   â”‚     â”‚           â”œâ”€> cover_url, media_urls
   â”‚     â”‚           â”œâ”€> stats (view, like, etc)
   â”‚     â”‚           â””â”€> raw_metadata (å®Œæ•´æ•°æ®)
   â”‚     â”‚
   â”‚     â””â”€> é‡è¯•é€»è¾‘ (æœ€å¤š3æ¬¡)
   â”‚
   â”œâ”€> å¦‚æœå¯ç”¨åª’ä½“å¤„ç† (enable_archive_media_processing=True):
   â”‚     â”‚
   â”‚     â”œâ”€> æ£€æŸ¥ raw_metadata.archive.images
   â”‚     â”‚
   â”‚     â”œâ”€> store_archive_images_as_webp()
   â”‚     â”‚     â”‚
   â”‚     â”‚     â”œâ”€> å¯¹æ¯å¼ å›¾ç‰‡:
   â”‚     â”‚     â”‚     â”œâ”€> ä¸‹è½½åŸå›¾
   â”‚     â”‚     â”‚     â”‚     â””â”€> httpx.get(img_url, headers)
   â”‚     â”‚     â”‚     â”‚
   â”‚     â”‚     â”‚     â”œâ”€> WebP è½¬ç 
   â”‚     â”‚     â”‚     â”‚     â”œâ”€> PIL.Image.open(data)
   â”‚     â”‚     â”‚     â”‚     â””â”€> save(format="WEBP", quality=80)
   â”‚     â”‚     â”‚     â”‚
   â”‚     â”‚     â”‚     â”œâ”€> è®¡ç®— SHA256
   â”‚     â”‚     â”‚     â”‚     â””â”€> hashlib.sha256(webp_data).hexdigest()
   â”‚     â”‚     â”‚     â”‚
   â”‚     â”‚     â”‚     â”œâ”€> ç”Ÿæˆå­˜å‚¨ key
   â”‚     â”‚     â”‚     â”‚     â””â”€> blobs/sha256/XX/YY/{hash}.webp
   â”‚     â”‚     â”‚     â”‚
   â”‚     â”‚     â”‚     â”œâ”€> ä¸Šä¼ åˆ°å­˜å‚¨åç«¯
   â”‚     â”‚     â”‚     â”‚     â”œâ”€> storage.exists(key) ? è·³è¿‡
   â”‚     â”‚     â”‚     â”‚     â””â”€> storage.put_bytes(key, data)
   â”‚     â”‚     â”‚     â”‚
   â”‚     â”‚     â”‚     â””â”€> æ›´æ–° metadata
   â”‚     â”‚     â”‚           â”œâ”€> stored_key
   â”‚     â”‚     â”‚           â”œâ”€> stored_url (presigned or public)
   â”‚     â”‚     â”‚           â”œâ”€> stored_sha256
   â”‚     â”‚     â”‚           â””â”€> width, height, size
   â”‚     â”‚     â”‚
   â”‚     â”‚     â””â”€> è¿”å›æ›´æ–°åçš„ metadata
   â”‚     â”‚
   â”‚     â””â”€> æ›´æ–° Content.raw_metadata
   â”‚
   â”œâ”€> æ›´æ–° Content å­—æ®µ
   â”‚     â”œâ”€> title, description
   â”‚     â”œâ”€> author_name, author_id
   â”‚     â”œâ”€> platform_id
   â”‚     â”œâ”€> content_type
   â”‚     â”œâ”€> cover_url, media_urls (å¯¹å¤–åˆ†äº«)
   â”‚     â”œâ”€> view_count, like_count, etc
   â”‚     â”œâ”€> extra_stats
   â”‚     â”œâ”€> raw_metadata (å®Œæ•´å½’æ¡£)
   â”‚     â””â”€> published_at
   â”‚
   â”œâ”€> æ›´æ–°çŠ¶æ€ â†’ PULLED
   â”‚     â””â”€> æ¸…ç† last_error, last_error_type ç­‰
   â”‚
   â”œâ”€> æäº¤äº‹åŠ¡
   â”‚
   â””â”€> queue.mark_complete(content_id)
```

### 4.3 Bot æ¨é€æµç¨‹

```
ç”¨æˆ·å‘é€ /get [tag]
   â”‚
   â”œâ”€> Bot æ”¶åˆ°å‘½ä»¤
   â”‚
   â”œâ”€> POST /api/v1/bot/get-content
   â”‚     â”œâ”€> body: {target_platform, tag, limit}
   â”‚     â”‚
   â”‚     â””â”€> [API] æŸ¥è¯¢å¾…æ¨é€å†…å®¹
   â”‚           â”œâ”€> SELECT FROM contents
   â”‚           â”‚     WHERE status = 'PULLED'
   â”‚           â”‚     AND id NOT IN (
   â”‚           â”‚       SELECT content_id FROM pushed_records
   â”‚           â”‚       WHERE target_platform = ?
   â”‚           â”‚     )
   â”‚           â”‚     AND (tag IS NULL OR ? = ANY(tags))
   â”‚           â”‚     ORDER BY published_at DESC
   â”‚           â”‚     LIMIT ?
   â”‚           â”‚
   â”‚           â””â”€> è¿”å› [Content]
   â”‚
   â”œâ”€> Bot æ ¼å¼åŒ–å†…å®¹
   â”‚     â””â”€> format_content_for_tg(content)
   â”‚           â”œâ”€> æ ‡é¢˜
   â”‚           â”œâ”€> ä½œè€…
   â”‚           â”œâ”€> ç®€ä»‹
   â”‚           â”œâ”€> äº’åŠ¨æ•°æ®
   â”‚           â”œâ”€> æ ‡ç­¾
   â”‚           â””â”€> åŸå§‹é“¾æ¥
   â”‚
   â”œâ”€> Bot å‘é€åˆ°é¢‘é“
   â”‚     â”œâ”€> å¦‚æœæœ‰å°é¢å›¾:
   â”‚     â”‚     â””â”€> bot.send_photo(channel_id, cover_url, caption)
   â”‚     â”‚
   â”‚     â””â”€> å¦åˆ™:
   â”‚           â””â”€> bot.send_message(channel_id, text)
   â”‚
   â”œâ”€> å¼‚æ­¥æ ‡è®°å·²æ¨é€ (ä¸é˜»å¡)
   â”‚     â””â”€> asyncio.create_task(
   â”‚           POST /api/v1/bot/mark-pushed
   â”‚             â”œâ”€> body: {content_id, target_platform}
   â”‚             â”‚
   â”‚             â””â”€> [API] åˆ›å»ºæ¨é€è®°å½•
   â”‚                   â”œâ”€> INSERT INTO pushed_records
   â”‚                   â””â”€> COMMIT
   â”‚         )
   â”‚
   â””â”€> å›å¤ç”¨æˆ·: âœ… å·²å‘é€
```

### 4.4 MinIO å­˜å‚¨æµç¨‹

```
Worker å¤„ç†å½’æ¡£å›¾ç‰‡
   â”‚
   â”œâ”€> storage = get_storage_backend()
   â”‚     â””â”€> æ ¹æ® storage_backend é…ç½®
   â”‚           â”œâ”€> "local" â†’ LocalStorageBackend
   â”‚           â””â”€> "s3" â†’ S3StorageBackend
   â”‚
   â”œâ”€> [MinIO] ç¡®ä¿ bucket å­˜åœ¨
   â”‚     â””â”€> storage.ensure_bucket()
   â”‚           â”œâ”€> s3.head_bucket(bucket)
   â”‚           â”‚     â””â”€> 404 â†’ åˆ›å»º bucket
   â”‚           â””â”€> s3.create_bucket(bucket)
   â”‚
   â”œâ”€> ä¸‹è½½å¹¶è½¬ç å›¾ç‰‡ â†’ webp_data
   â”‚
   â”œâ”€> è®¡ç®—å†…å®¹å¯»å€ key
   â”‚     â””â”€> blobs/sha256/AB/CD/ABCD...WXYZ.webp
   â”‚
   â”œâ”€> æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
   â”‚     â””â”€> exists = storage.exists(key)
   â”‚           â””â”€> s3.head_object(bucket, key)
   â”‚
   â”œâ”€> å¦‚æœä¸å­˜åœ¨:
   â”‚     â””â”€> storage.put_bytes(key, webp_data, "image/webp")
   â”‚           â”œâ”€> s3.put_object(
   â”‚           â”‚     Bucket=bucket,
   â”‚           â”‚     Key=key,
   â”‚           â”‚     Body=webp_data,
   â”‚           â”‚     ContentType="image/webp"
   â”‚           â”‚   )
   â”‚           â”‚
   â”‚           â””â”€> è¿”å› StoredObject
   â”‚                 â”œâ”€> key
   â”‚                 â”œâ”€> size
   â”‚                 â”œâ”€> sha256
   â”‚                 â””â”€> url
   â”‚
   â”œâ”€> è·å–è®¿é—® URL
   â”‚     â””â”€> url = storage.get_url(key)
   â”‚           â”‚
   â”‚           â”œâ”€> å¦‚æœå¯ç”¨é¢„ç­¾å:
   â”‚           â”‚     â””â”€> s3.generate_presigned_url(
   â”‚           â”‚           "get_object",
   â”‚           â”‚           {Bucket, Key},
   â”‚           â”‚           ExpiresIn=3600
   â”‚           â”‚         )
   â”‚           â”‚
   â”‚           â””â”€> å¦åˆ™ (å…¬å¼€æ¡¶):
   â”‚                 â””â”€> {public_base_url}/{bucket}/{key}
   â”‚
   â””â”€> ä¿å­˜åˆ° metadata
         â””â”€> archive.images[i].stored_url = url
```

---

## 5. é…ç½®è¯´æ˜

### 5.1 ç¯å¢ƒå˜é‡ (.env)

```bash
# === åŸºç¡€é…ç½® ===
APP_ENV=dev                              # ç¯å¢ƒ: dev/prod
DEBUG=true                               # è°ƒè¯•æ¨¡å¼
DEBUG_SQL=false                          # SQL æ—¥å¿— (æ–°å¢)
LOG_LEVEL=INFO                           # æ—¥å¿—çº§åˆ«
LOG_FORMAT=json                          # æ—¥å¿—æ ¼å¼: json/text

# === æ•°æ®åº“ ===
DATABASE_URL=postgresql+asyncpg://user:password@localhost:5432/vaultstream

# === Redis ===
REDIS_URL=redis://localhost:6379/0

# === API ===
API_HOST=0.0.0.0
API_PORT=8000
API_TOKEN=your_secret_token              # API é‰´æƒ Token

# === Telegram Bot ===
ENABLE_BOT=false                         # æ˜¯å¦å¯ç”¨ Bot
TELEGRAM_BOT_TOKEN=123456:ABC-DEF...     # Bot Token
TELEGRAM_CHANNEL_ID=@your_channel        # é¢‘é“ ID

# === å…¨å±€HTTPä»£ç†ï¼ˆå¯é€‰ï¼Œç”¨äºTelegramã€Twitterã€YouTubeç­‰ï¼‰===
HTTP_PROXY=http://127.0.0.1:7890         # HTTPä»£ç†åœ°å€
# HTTPS_PROXY=http://127.0.0.1:7890      # HTTPSä»£ç†åœ°å€ï¼ˆå¯é€‰ï¼‰

# === Bç«™ Cookies (å¯é€‰) ===
BILIBILI_SESSDATA=your_sessdata
BILIBILI_BILI_JCT=your_bili_jct
BILIBILI_BUVID3=your_buvid3

# === å­˜å‚¨åç«¯ ===
STORAGE_BACKEND=s3                       # local æˆ– s3
STORAGE_PUBLIC_BASE_URL=http://localhost:9000  # å…¬å¼€è®¿é—®åœ°å€

# --- æœ¬åœ°å­˜å‚¨ ---
STORAGE_LOCAL_ROOT=data/storage

# --- MinIO/S3 å­˜å‚¨ ---
STORAGE_S3_ENDPOINT=http://localhost:9000
STORAGE_S3_REGION=us-east-1
STORAGE_S3_BUCKET=vaultstream
STORAGE_S3_ACCESS_KEY=minioadmin
STORAGE_S3_SECRET_KEY=minioadmin
STORAGE_S3_PRESIGN_URLS=true             # ä½¿ç”¨é¢„ç­¾å URL
STORAGE_S3_PRESIGN_EXPIRES=3600          # é¢„ç­¾åæœ‰æ•ˆæœŸ(ç§’)

# === åª’ä½“å¤„ç† ===
ENABLE_ARCHIVE_MEDIA_PROCESSING=true     # å¯ç”¨å½’æ¡£åª’ä½“å¤„ç†
ARCHIVE_IMAGE_WEBP_QUALITY=80            # WebP è´¨é‡ (1-100)
ARCHIVE_IMAGE_MAX_COUNT=20               # æœ€å¤§å›¾ç‰‡æ•°é‡
```

### 5.2 Docker Compose æœåŠ¡

```yaml
services:
  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: vaultstream
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  minio:
    image: minio/minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    ports:
      - "9000:9000"       # API
      - "9001:9001"       # Console
    volumes:
      - minio_data:/data
```

---

## 6. çŠ¶æ€æœºå’Œé”™è¯¯å¤„ç†

### 6.1 Content çŠ¶æ€è½¬æ¢

```
UNPROCESSED  â”€â”€â”
               â”‚ Worker è·å–ä»»åŠ¡
               â†“
           PROCESSING â”€â”€â”
               â”‚        â”‚ è§£æå¤±è´¥
               â”‚        â†“
               â”‚     FAILED â”€â”€â”
               â”‚        â†‘     â”‚ é‡è¯•
               â”‚        â””â”€â”€â”€â”€â”€â”˜ (æœ€å¤š3æ¬¡)
               â”‚ è§£ææˆåŠŸ
               â†“
            PULLED
```

### 6.2 é”™è¯¯åˆ†ç±»

| é”™è¯¯ç±»å‹ | æ˜¯å¦é‡è¯• | å¤„ç†ç­–ç•¥ |
|---------|---------|---------|
| ç½‘ç»œè¶…æ—¶ | âœ… | æŒ‡æ•°é€€é¿é‡è¯• |
| ä¸´æ—¶æ•…éšœ(5xx) | âœ… | æŒ‡æ•°é€€é¿é‡è¯• |
| æƒé™ä¸è¶³(403) | âŒ | æ ‡è®°å¤±è´¥ï¼Œéœ€äººå·¥ä»‹å…¥ |
| å†…å®¹ä¸å­˜åœ¨(404) | âŒ | æ ‡è®°å¤±è´¥ |
| å†…å®¹éœ€ç™»å½• | âŒ | è®°å½• auth_required |
| è§£æå¼‚å¸¸ | âŒ | è®°å½•è¯¦ç»†é”™è¯¯ä¿¡æ¯ |

### 6.3 å¤±è´¥è®°å½•

```python
Content.failure_count       # å¤±è´¥æ¬¡æ•°ç»Ÿè®¡
Content.last_error          # é”™è¯¯æ¶ˆæ¯
Content.last_error_type     # é”™è¯¯ç±»å‹ (å¼‚å¸¸ç±»å)
Content.last_error_detail   # è¯¦ç»†ä¿¡æ¯ (å« traceback)
Content.last_error_at       # å¤±è´¥æ—¶é—´
```

---

## 7. æ€§èƒ½ä¼˜åŒ–

### 7.1 å·²å®æ–½ä¼˜åŒ–

1. å¼‚æ­¥ I/O
   - FastAPI å¼‚æ­¥è·¯ç”±
   - asyncpg å¼‚æ­¥æ•°æ®åº“
   - httpx å¼‚æ­¥ HTTP å®¢æˆ·ç«¯

2. è¿æ¥å¤ç”¨
   - æ•°æ®åº“è¿æ¥æ± 
   - Bot httpx client å¤ç”¨
   - Redis è¿æ¥å¤ç”¨

3. ä»»åŠ¡é˜Ÿåˆ—
   - è§£è€¦è¯·æ±‚å’Œå¤„ç†
   - åå°å¼‚æ­¥å¤„ç†
   - å¹¶å‘æ§åˆ¶

4. å†…å®¹å¯»å€å­˜å‚¨
   - å»é‡å­˜å‚¨
   - å‡å°‘ç½‘ç»œä¼ è¾“
   - é™ä½å­˜å‚¨æˆæœ¬

5. æ—¥å¿—ç²¾ç®€ (æœ¬æ¬¡ä¼˜åŒ–)
   - å…³é—­ SQL echo
   - å‡å°‘ debug æ—¥å¿—
   - ç‹¬ç«‹ debug_sql é…ç½®

6. Bot ä¼˜åŒ– (æœ¬æ¬¡ä¼˜åŒ–)
   - å¤ç”¨ httpx å®¢æˆ·ç«¯
   - å¼‚æ­¥æ ‡è®°æ¨é€çŠ¶æ€
   - å‡å°‘é˜»å¡ç­‰å¾…

### 7.2 æœªæ¥ä¼˜åŒ–æ–¹å‘

1. ç¼“å­˜å±‚
   - Redis ç¼“å­˜çƒ­ç‚¹å†…å®¹
   - CDN åŠ é€Ÿåª’ä½“è®¿é—®

2. æ‰¹é‡å¤„ç†
   - æ‰¹é‡ä¸‹è½½å›¾ç‰‡
   - æ‰¹é‡æ•°æ®åº“æ“ä½œ

3. å¹¶å‘æ§åˆ¶
   - Worker å¤šè¿›ç¨‹/å¤šçº¿ç¨‹
   - é™æµå’Œç†”æ–­

4. ç›‘æ§å’Œå‘Šè­¦
   - Prometheus + Grafana
   - é”™è¯¯ç‡ã€å»¶è¿Ÿç›‘æ§

---

## 8. å®‰å…¨è€ƒè™‘

### 8.1 API é‰´æƒ

- ç®€å• Token é‰´æƒ (M1)
- æ”¯æŒ `X-API-Token` å¤´æˆ– `Authorization: Bearer`
- æœªé…ç½®æ—¶æ”¾è¡Œï¼ˆä¾¿äºå¼€å‘ï¼‰

### 8.2 æ•°æ®éš”ç¦»

- MinIO ç§æœ‰æ¡¶ + é¢„ç­¾å URL
- æ•æ„Ÿé…ç½®ä½¿ç”¨ `SecretStr`
- æ—¥å¿—ä¸è¾“å‡ºæ•æ„Ÿå€¼

### 8.3 è¾“å…¥éªŒè¯

- Pydantic æ¨¡å‹éªŒè¯
- URL è§„èŒƒåŒ–é˜²æ³¨å…¥
- å¹³å°æ£€æµ‹é˜²æ»¥ç”¨

---

## 9. æ‰©å±•æ€§

### 9.1 æ–°å¢å¹³å°é€‚é…å™¨

```python
# 1. åˆ›å»ºé€‚é…å™¨
class YouTubeAdapter(BaseAdapter):
    platform = Platform.YOUTUBE
    
    async def parse(self, url: str) -> ParsedContent:
        # å®ç°è§£æé€»è¾‘
        pass
    
    async def clean_url(self, url: str) -> str:
        # URL è§„èŒƒåŒ–
        pass

# 2. æ³¨å†Œåˆ°å·¥å‚
AdapterFactory._adapters[Platform.YOUTUBE] = YouTubeAdapter

# 3. æ·»åŠ å¹³å°æ£€æµ‹è§„åˆ™
AdapterFactory._patterns.append(
    (re.compile(r'youtube\.com|youtu\.be'), Platform.YOUTUBE)
)
```

### 9.2 æ–°å¢å­˜å‚¨åç«¯

```python
class AzureBlobStorage(StorageBackend):
    async def put_bytes(self, *, key, data, content_type):
        # å®ç°ä¸Šä¼ 
        pass
    
    async def exists(self, *, key):
        # æ£€æŸ¥å­˜åœ¨
        pass
    
    def get_url(self, *, key):
        # ç”Ÿæˆè®¿é—® URL
        pass
```

### 9.3 æ–°å¢æ¨é€ç›®æ ‡

```python
# æ·»åŠ æ¨é€è®°å½•æ—¶ä½¿ç”¨ä¸åŒ target_platform
# ä¾‹å¦‚: DISCORD_CHANNEL_xxx, SLACK_CHANNEL_xxx
```

---

## 10. éƒ¨ç½²æ¶æ„

### å¼€å‘ç¯å¢ƒ

```
MacBook/PC
â”œâ”€> Docker Desktop
â”‚   â”œâ”€> PostgreSQL (5432)
â”‚   â”œâ”€> Redis (6379)
â”‚   â””â”€> MinIO (9000, 9001)
â”œâ”€> Python venv
â”‚   â”œâ”€> FastAPI App (8000)
â”‚   â””â”€> Worker (background)
â””â”€> Telegram Bot (å¯é€‰)
```

### ç”Ÿäº§ç¯å¢ƒ (æ¨è)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             åå‘ä»£ç† (Nginx)             â”‚
â”‚  - HTTPS ç»ˆæ­¢                            â”‚
â”‚  - é™æ€æ–‡ä»¶æœåŠ¡                          â”‚
â”‚  - è´Ÿè½½å‡è¡¡                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         åº”ç”¨å±‚ (å¤šå®ä¾‹)                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  FastAPI #1 â”‚  â”‚  FastAPI #2 â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  Worker #1  â”‚  â”‚  Worker #2  â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚     Bot     â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          æ•°æ®å±‚ (æ‰˜ç®¡æœåŠ¡)               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  PostgreSQL  â”‚  â”‚    Redis     â”‚    â”‚
â”‚  â”‚  (RDS/äº‘)    â”‚  â”‚  (äº‘ç¼“å­˜)    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚    MinIO     â”‚                      â”‚
â”‚  â”‚  (å¯¹è±¡å­˜å‚¨)  â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 11. æŠ€æœ¯æ ˆæ€»ç»“

| å±‚æ¬¡ | æŠ€æœ¯ | ç”¨é€” |
|------|------|------|
| Web æ¡†æ¶ | FastAPI | å¼‚æ­¥ API æœåŠ¡ |
| æ•°æ®åº“ | PostgreSQL | å…³ç³»å‹æ•°æ®å­˜å‚¨ |
| ORM | SQLAlchemy (async) | æ•°æ®åº“è®¿é—® |
| ç¼“å­˜/é˜Ÿåˆ— | Redis | ä»»åŠ¡é˜Ÿåˆ—ã€ä¼šè¯å­˜å‚¨ |
| å¯¹è±¡å­˜å‚¨ | MinIO (S3å…¼å®¹) | åª’ä½“æ–‡ä»¶å­˜å‚¨ |
| HTTP å®¢æˆ·ç«¯ | httpx | å¼‚æ­¥ HTTP è¯·æ±‚ |
| Bot æ¡†æ¶ | python-telegram-bot | Telegram é›†æˆ |
| å›¾åƒå¤„ç† | Pillow | WebP è½¬ç  |
| æ—¥å¿— | loguru | ç»“æ„åŒ–æ—¥å¿— |
| é…ç½®ç®¡ç† | pydantic-settings | ç¯å¢ƒå˜é‡ç®¡ç† |
| å®¹å™¨åŒ– | Docker Compose | æœ¬åœ°å¼€å‘ç¯å¢ƒ |

---

## é™„å½•ï¼šå¿«é€Ÿå‚è€ƒ

### å¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨åŸºç¡€è®¾æ–½
docker-compose up -d postgres redis minio

# å¯åŠ¨åº”ç”¨
./start.sh              # FastAPI + Worker

# å¯åŠ¨ Bot (å¦ä¸€ä¸ªç»ˆç«¯)
python -m app.bot
```

### å¸¸ç”¨ API

```bash
# åˆ›å»ºåˆ†äº«
curl -X POST http://localhost:8000/api/v1/shares \
  -H "Content-Type: application/json" \
  -d '{"url": "https://www.bilibili.com/opus/933099353259638816"}'

# æŸ¥è¯¢å†…å®¹
curl http://localhost:8000/api/v1/contents?status=PULLED

# å¥åº·æ£€æŸ¥
curl http://localhost:8000/api/v1/health
```

### è°ƒè¯•æŠ€å·§

```bash
# å¼€å¯ SQL æ—¥å¿—
DEBUG_SQL=true ./start.sh

# æŸ¥çœ‹ Redis é˜Ÿåˆ—
redis-cli
> LLEN vaultstream:tasks
> LRANGE vaultstream:tasks 0 -1

# æŸ¥çœ‹ MinIO å¯¹è±¡
mc alias set local http://localhost:9000 minioadmin minioadmin
mc ls local/vaultstream/blobs/sha256/
```

---

ç‰ˆæœ¬: v0.1  
æœ€åæ›´æ–°: 2026-01-03  
