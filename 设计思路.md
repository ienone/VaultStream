# VaultStream 设计思路

## 1\. 目标

构建一个“超级收藏夹”（VaultStream）。通过移动端便捷标记与深度适配器，将跨平台（B站、Twitter、小红书等）的碎片化内容自动化抓取并结构化存储，支持标签管理、AI 摘要、语义检索与按需分享。

## 2\. 核心系统架构

### A. 数据输入与采集层 (The Input)

该层负责多源数据的接入与预处理，注重便利性。

- 多平台适配器 (Adapters)  
  - URL 净化：自动剥离 ?utm\_source=... 等追踪参数及短链接还原 
  - 平台覆盖：B站（动态/视频）、Twitter（推文/媒体）、小红书（图文）、微博、知乎等 
- MD3 移动端 App (The Trigger)  
  - 交互规范：采用 Material Design 3 (Expressive) 风格，强化色彩对比与灵动特效 
  - 分享承接：作为系统级的 Share Target，用户在其他 App 点击分享即可唤起快捷操作 
  - 快速打标：预设分类（Cos/Tech/Meme），支持自定义标签及一键 NSFW 标记 
- 采集模式  
  - 主动模式：用户手动分享链接触发同步 
  - 被动模式：针对重点博主/账号设置定时监控，实现全量自动存档。

### B. 后端处理与存储层 (The Process)

系统的心脏，负责异步爬虫调度与数据的持久化。

- 异步解析流水线 (Pipeline) 
  - Twitter：抓取原图链接、Coser/推主 ID、正文文本 
  - Bilibili：利用 API 或爬虫获取封面、播放数据、UP主信息及简介 
  - 逐步完善：后续支持微博、知乎等平台的定制化解析
  - 通用提取：针对小红书/知乎等，提取核心视觉元素与正文 
- 结构化存储 (PostgreSQL)  
  - JSONB 驱动：利用 PostgreSQL 的 JSONB 特性存储各平台差异巨大的元数据（Metadata），保证 schema 的灵活性 
  - 状态机管理：定义内容状态流转：Unprocessed \-\> Pulled \-\> Distributed \-\> Archived 
- 反爬避障策略  
  - 尽量优先用提供api的和公开api的方式获取数据
  - 协同解析：利用手机端已登录的 Cookie 或 Token 进行辅助解析 

### C. 信息展示层 (The Output)

- 多维适配架构： 采用解耦的插件化设计，开发者可快速为不同平台编写专属适配器，实现URL净化与元数据提取。
- 多端交互： 
    - 用flutter开发应用，基于 Material 3 expressive规范，支持通过系统分享快捷收藏/打标，支持查看管理/检索/收藏内容并管理
    - 管理后台 (Web)： 利用flutter跨平台能力，和移动端同步开发，支持批量导入/导出、标签管理、AI 摘要生成等高级功能。

- 自动化分发网络： 结合 Astrbot 等机器人框架，支持基于标签的轨道式推送，实现 QQ/TG 等多平台的定时、定向分享。

  - 多轨道策略：根据 Tag 路由内容。例如：Tag:Tech \-\> TG 技术频道；Tag:Cos \-\> TG 私密频道 
  - 推送模式：  
    - 主动推送：定时任务轮询 pushed=false 记录 
    - 指令拉取：群成员通过 /get \[tag\] 获取未发布内容，增加互动性
    - 用批量转发聊天记录包裹，减少机器人消息数量
    - 尽量用图文混排的方式发送信息
    - 避免重复推送：实现“推过不再发”逻辑，防止刷屏

- 检索与标记  
  - TG 消息自动携带 \#ChannelName，方便搜索。

## 3\. 技术栈计划 (Tech Stack)

| 维度 | 推荐技术 | 理由 |
| :---- | :---- | :---- |
| 移动端 | Flutter | MD3 适配能力，一套代码支持多平台开发|
| 后端 | Python (FastAPI) | 高并发异步支持，丰富的爬虫生态（Playwright, yt-dlp）|
| 数据库 | PostgreSQL | JSONB处理，稳定性高|
| 机器人 | Astrbot | 深度集成主流协议，适配 QQ/TG，支持扩展插件|
| 缓存/队列 | Redis | 负责任务去重、爬虫队列以及临时状态缓存|

## 4\. 关键逻辑与合规性设计

### 4.1 "推过不再发"逻辑

1. 关联表记录：创建 pushed\_records 表，记录 content\_id、target\_platform、timestamp 
2. 排期算法：定时任务每天检索状态为 pushed \= false 的内容 
3. 即时更新：内容一旦通过主动推送或指令拉取被发出，立即原子性更新 pushed 状态

### 4.2 内容合规性与安全

-严格区分私有存档与分享：
  - 私有库： 存储全量信息，不支持分享
  - 合规分享： 分享卡片形式，仅包含标题、摘要、封面图等
- 海外内容：  
  - 国内节点：部署 Web 端、B 站爬虫及 QQ 机器人 
  - 对于tg/twitter等被墙平台：考虑使用手机应用在浏览时就抓取内容
  - 或者海外节点部署 Twitter 爬虫及 TG 机器人，通过内网穿透或 API 转发数据回国内数据库

## 5. 实现路径（MVP -> 可用 -> 完整）

- MVP（先跑通闭环）：分享入口（URL+标签） -> Adapter 解析 -> 入库（私有） -> TG 机器人按 Tag 拉取 -> 写 pushed_records
- 可用版（面向日常使用）：分发规则（Tag 路由 + NSFW 分流）-> 主动定时推送 -> Web 管理/检索（基础权限）
- 完整版（体验/智能化）：移动端 Share Target（Flutter）-> 语义检索/AI 摘要 -> 被动监控（重点账号）-> 可观测/告警

> 开发任务清单见 `TODO.md`（以“收藏为主、合规分享为输出”为原则）。
