# VaultStream 项目优化总结 - 2026-01-28

## 1. 前端 UI 优化 (Material 3 Expressive)

### 1.1 规则详情交互优化
*   **浮动效果**: 重构了内容队列页面的布局，规则详情框现在以“悬浮”方式显示在内容上方（通过 `Stack` 和 `Positioned` 实现），不再挤压下方列表，解决了展开/收缩时的页面跳动问题。
*   **动画增强**: 为规则详情框添加了 `AnimatedContainer` 背景色过渡和 `AnimatedSize` 展开动画，视觉效果更平滑。
*   **图标修正**: 移除了详情框内部冗余的向上箭头，将操作按钮统一改为箭头样式（`keyboard_arrow_down/up`），且点击“编辑规则”时详情框保持展开状态。
*   **空间利用**: 调大了详情框内部文字和图标的尺寸（`bodySmall` -> `bodyMedium`），提升了高分辨率屏幕下的可读性。

### 1.2 类别选择器重构
*   将原有的生硬按钮替换为 Material 3 的 `SegmentedButton`，并在标签内集成了实时计数（如：待推送 (14)），整体风格更符合 Expressive 设计规范。

### 1.3 规则管理功能增强
*   **标签筛选**: 在“编辑/创建规则”对话框中增加了完整的标签筛选 UI，支持包含标签、排除标签以及匹配模式（Any/All）的配置。
*   **分发目标配置**: **新增了“分发目标”管理界面**。用户现在可以在规则编辑弹窗中直接添加、删除或启用/禁用分发目标（如 Telegram 频道 ID），解决了因规则缺少目标导致分发任务为 0 的核心问题。
*   **删除功能**: 在垂直布局模式下增加了“删除规则”按钮，并配有二次确认弹窗。

## 2. 推送逻辑修复与增强 (M4)

### 2.1 重推逻辑 (Repush) 闭环修复
针对“点重推后无反应/不出现在队列”的问题，进行了全流程排查和修复：
1.  **前端状态更新**: 修复了重推按钮点击后不刷新本地状态的问题。
2.  **路由逻辑**: 在移动内容到 `will_push` 状态时，强制将 `Content.status` 重置为 `PULLED`，确保调度器能再次扫描到已推送过的内容。
3.  **智能去重**: 优化了 `DistributionEngine` 的去重逻辑。现在会比较内容的 `reviewed_at`（审核时间）与最后一次推送记录的 `pushed_at`。如果审核时间更晚（即用户手动触发了重推），则允许通过去重检查。
4.  **Worker 同步**: 同步更新了后台 `Worker` 中的去重检查，确保重推任务不会被执行器拦截。

### 2.2 规则匹配逻辑优化
*   **匹配权限**: 修改为 permissive 模式，即没有配置匹配条件的规则将默认匹配所有内容，方便设置“通用规则”。
*   **状态支持**: 增加了对 `AUTO_APPROVED`（自动通过）内容的推送支持。
*   **大小写不敏感**: 标签匹配现在忽略大小写（如 `girl` 匹配 `Girl`）。

### 2.3 调度器改进
*   **优先级支持**: 分发调度器现在严格遵守内容队列的自定义排序（`queue_priority`），高优先级内容会优先推送到任务队列。

## 3. 系统维护与可观测性

### 3.1 手动触发推送
*   **后端**: 新增了 `POST /api/v1/distribution/trigger-run` 接口，允许绕过 60s 定时器立即执行一次分发扫描。
*   **前端**: 在“Bot 状态卡片”中增加了“立即推送”按钮，方便用户即时测试规则。

### 3.2 日志系统增强
*   大幅增加了分发过程中的关键路径日志：
    *   分发调度器发现的候选数量。
    *   规则匹配的具体结果（为什么被过滤）。
    *   消息发送前的载荷预览（Payload Debug）。

### 3.3 测试覆盖
*   完善了 `frontend/test` 中的测试用例，包括 `DistributionRule` 和 `QueueItem` 的模型解析测试、性能渲染基准测试（100条数据渲染压测）以及 `ReviewPage` 的 UI 交互测试。

## 4. 待办与建议 (Troubleshooting)

*   **Bot 连接问题**: 
    *   如果 Bot 日志中出现 `Timed out` 或 `RemoteProtocolError`，请检查 `.env` 中的 `HTTP_PROXY` 配置（如 `http://127.0.0.1:7890`）。
    *   **修复**: 修复了 `TelegramPushService` 初始化 Bot 时传递代理参数的方式（适配 `python-telegram-bot` v20+，使用 `HTTPXRequest`），解决了 `unexpected keyword argument 'proxy_url'` 错误。
    *   **Worker 稳定性**: 修复了 `ContentDistributor` 中因重复使用 SQLAlchemy 游标导致的 `This result object is closed` 崩溃问题，确保推送记录能正确写入数据库。
*   **推送说明文件**: 详细的推送流程梳理已生成至 `docs/PUSH_LOGIC.md`。
